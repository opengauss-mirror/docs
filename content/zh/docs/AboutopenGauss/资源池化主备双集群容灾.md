# 资源池化主备双集群容灾

## 特性简介

本特性实现主备双集群的XLog日志同步，保证主备双集群的XLog一致性，从而增强主备双集群的容灾能力，降低存储空间，并保证主备集群内节点切换、主备集群间切换功能正常。

## 可获得性

基于流复制的主备双集群容灾自openGauss 6.0.0-RC1版本开始引入。

基于DORADO存储同步复制的主备双集群容灾自openGauss 5.1.0版本开始引入。

## 客户价值

提供给客户在极端灾难情况下数据的安全性和服务的可用性，多种模式满足不同场景下的需求。

## 特性描述

资源池化双集群容灾通过多种同步方式将主集群的XLog日志同步至备集群，备集群通过回放来自主集群的XLog实现数据一致性，以便于主集群发生严重故障时，备集群可以及时接管主集群业务。目前可以通过基于网络的流复制，以及基于DORADO存储的同步复制。


## 特性增强

1. 主备集群间极致RTO
    - 在30万tpmc下，集群间极致RTO时间小于20s。
    
    **使用限制**: 
    - 本特性自openGauss 6.0.0-RC1版本开始引入，只适用于资源池化部署的基于DORADO存储同步复制的主备双集群。
    - 只适用于主备集群间切换，不适用于集群内切换。
    - 开启极致RTO的情况下，备集群不支持读业务。
    
    **使用说明**: 
    - 备集群配置极致RTO参数，关闭备机可读。
    - 在主集群故障的场景下，备集群升为主集群。
    - 在30万tpmc下，集群间极致RTO时间小于20s。

2. 极致RTO备机可读（BETA特性）

    **使用限制**: 
    - 本特性自openGauss 7.0.0-RC1版本开始引入，只适用于资源池化部署的主备双集群。
    - 开启极致RTO的情况下，备集群不支持switchover，备集群从备不支持读业务。
    
    **使用说明**: 
    - 备集群配置极致RTO参数，开启hot_standby，首备可读。
    - 从备通过failover升为首备后可读，备集群升为主集群后所有节点可读。

3. 主集群按需回放

    **使用限制**:
    - 本特性自openGauss 7.0.0-RC2版本开始引入，只适用于资源池化部署的主集群。
    - 由于极致RTO备机可读是BETA特性，该特性需设置hot_standby=off。
    
    **使用说明**:
    - 资源池化部署的主集群开启按需回放参数后功能正常，备集群开启不生效。

## 特性约束

- 不支持两种双集群同时使用。

## 依赖关系

- 本特性依赖openGauss资源池化架构。
- 本特性依赖DORADO存储设备。

## 基本原理

双集群部署方面采用初始化和build功能安装部署可用的双集群系统，build功能用于保证主备集群最初的数据一致性。主集群主机以primary启动，备集群主机以集成DMS和DSS的传统备启动，其他节点以normal启动。在正常运行过程中，备集群主机回放完本地日志后，会请求主集群主机的XLog，并通过回放来达到数据一致性。

## 使用指导

本特性分为两种模式:
1. 基于网络的流复制模式：[资源池化网络双集群部署](../DatabaseAdministrationGuide/资源池化网络双集群部署.md)
2. 基于DORADO存储的同步复制模式：[资源池化DORADO双集群部署](../DatabaseAdministrationGuide/资源池化DORADO双集群部署.md)

## 使用场景

- 在单集群部署的场景下，一旦出现机房极端故障，短时间内无法恢复，在双集群部署的场景下，可以快速使备集群升主接管业务，保证业务不中断，在主集群正常运行过程中，也可以作为主集群的计算业务分流。
- 基于流复制的主备双集群，利用openGauss传统集群中的XLog物理复制能力，能够灵活的配置主备集群间的复制关系，适用于同城或异地容灾场景。
- 基于DORADO复制的主备双集群容灾，利用了DORADO存储设备同步复制的能力，主集群XLog写入后，在链路正常的情况下，备集群可以读取到同样的XLog，适用于百公里级别的同城双中心容灾场景，传输速度快，典型业务场景下，在一个集群完全故障的情况下，RPO = 0，RT0 < 30s。