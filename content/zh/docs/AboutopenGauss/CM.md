# CM

## 可获得性<a name="section15406143204715"></a>

本特性自openGauss 3.0.0版本开始引入。

## 特性简介<a name="section740615433477"></a>

CM（Cluster Manager）是一款数据库管理软件，由cm\_server和cm\_agent组成。

-   cm\_agent是部署在数据库每个主机上，用来启停和监控各个数据库实例进程的数据库管理组件。
-   cm\_server是用来进行数据库实例管理和实例仲裁的组件。

## 客户价值<a name="section13406743164715"></a>

管理和监控数据库系统中各个功能单元和物理资源的运行情况，确保整个系统的稳定运行。

## 特性描述<a name="section16406154310471"></a>

支持自定义资源监控，提供了数据库主备的状态监控、网络通信故障监控、文件系统故障监控、故障自动主备切换等能力。提供了丰富的数据库管理能力，如节点、实例级的启停，数据库实例状态查询、主备切换、日志管理等。

## 特性增强<a name="section1340684315478"></a>

CM支持对外状态查询和推送能力
- 通过http/https服务远程查询到集群的状态，便于管理人员、运维平台等监控集群状态
- 在数据库集群发生切主事件时，通过http/https服务及时地将集群最新的主备信息推送到应用端注册的接收地址，便于应用端及时的感知到集群的主备变化，从而能够快速的连接到新的主机和备机。

CM支持两节点部署模式
- CM集群最小节点数限制由3节点减少为2节点，带来显著的成本优势
- 通过引入第三方网关IP，有效解决CM集群两节点部署模式下自仲裁问题，同时支持动态配置CM集群故障切换策略和数据库集群脑裂故障恢复策略，从而能够尽可能确保集群数据的完整性和一致性。

CM两节点部署增强（6.0.0引入）

- CM支持多个三方IP检测(third_party_gateway_ip)，可以预防CM脑裂。
- 当CM为两节点部署时，cm_server参数third_party_gateway_ip支持以逗号分隔的多个IP。在两节点环境中，cms_enable_failover_on2nodes配置为true时，节点1与节点2的cm_server会将以与第三方网关的连通条件作为cm_server是否升主的条件之一。具体如下：当节点CM与三方网关中配置的所有IP都能ping通时，CM会升主；当节点CM与三方网关中配置的所有IP都不能ping通时，CM会降备。即CM升主与降备的条件是三方网关的所有IP都能ping通或者不能ping通。

支持CM部署与数据库部署解耦

- 已经部署了openGauss数据库集群，但是尚未部署CM的集群直接部署CM，而不需要通过升级的方式将CM带入

支持一键式暂停/恢复CM服务  

- 支持一键暂停CM自动故障处理服务，避免运维人员在运维过程中的操作受到CM影响，运维完成之后可以一键恢复CM服务

支持按事件触发调用用户自定义脚本  

- 在特定事件发生后，由CM自动触发用户自定义的脚本，执行相应的操作

CM支持容器化部署  

- 支持将CM和数据库打包到docker镜像中，并启动两个以上的容器实例组成CM集群。
- 已经部署了openGauss数据库集群，但是尚未部署CM的集群直接部署CM，而不需要通过升级的方式将CM带入

支持一键式暂停/恢复CM服务  
- 支持一键暂停CM自动故障处理服务，避免运维人员在运维过程中的操作受到CM影响，运维完成之后可以一键恢复CM服务

支持按事件触发调用用户自定义脚本  
- 在特定事件发生后，由CM自动触发用户自定义的脚本，执行相应的操作


CM支持容器化部署
- 支持将CM和数据库打包到docker镜像中，并启动两个以上的容器实例组成CM集群。

CM支持在多数派节点未回放完的情况下选主（6.0.0引入）
- CM发起选主流程中，若多数派节点未回放完，直接找到Local max replay lsn最大的节点为主，指定其为主，等待该节点回放结束后升主，不再等待多数派回的节点放完。

CM磁盘使用率管理能力增强  

- 支持PGDATA目录下软连接（主要针对base、global、pg_xlog、pg_tblspc及以下表空间）所在真实目录对应磁盘使用率的管理。

CM支持最大可用模式动态调整（6.0.0引入）

- CM支持管理数据库最大可用模式参数most_available_sync。当数据库集群同步备机数量不满足要求时，CM可以打开数据库最大可用模式，以保证数据库主节点的可用性。
- 当允许CM管理数据库最大可用模式时，需要将cm_server.conf配置文件中enable_set_most_available_sync参数设置为on，否则应该设置为off。
- 当允许CM管理数据库最大可用模式时，如果数据库主节点因为同步备机故障或者期待的同步备机数量不足导致主机事务提交被hang住，由CM自动打开数据库最大可用模式；当同步备机数量满足要求时，由CM自动关闭数据库最大可用模式。

CM支持安装管理ipv6的数据库集群（7.0.0RC1引入）

## 特性约束<a name="section06531946143616"></a>

一主一备模式下，5.0.0之前的版本中CM只支持基本的安装、启停、检测能力，其他功能不支持。

## 依赖关系<a name="section8406643144716"></a>

无。

