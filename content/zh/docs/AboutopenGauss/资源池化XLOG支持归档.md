# 资源池化XLOG支持归档

## 特性简介

本特性实现资源池化单集群XLOG支持归档，支持备份恢复及通过归档的XLOG进行PITR恢复。

## 可获得性

本特性自openGauss 7.0.0-RC1版本开始引入。

## 客户价值

提升资源池化单集群场景下的可维护性，提升集群的稳定性和可靠性。

## 特性描述

在资源池化单集群场景下，开启归档相关参数后，XLOG会持续进行归档操作。当发生故障后，可以通过gs_probackup工具和归档的XLOG进行PITR恢复。

## 特性增强

无。

## 特性约束

-  本特性仅支持主节点开启归档参数，进行归档操作。
-  当wal_level参数为minimal时，归档功能无法开启使用。
-  本特性不会检测已归档的XLOG是否还有存在价值，若出现归档路径的盘空间满，则归档会停止直到归档路径盘存在可用空间(>1G，因为资源池化环境下的XLOG文件规格是1G)，因此需要用户自行进行归档的XLOG维护清理。若归档因盘空间不足而停止，此时进行备份操作会备份失败。
-  资源池化环境下，归档命令参数（archive_command）为dsscmd cp，暂时仅支持 cp 基本的复制操作，并且文件路径参数不支持使用相对路径，详情可以参考[dsscmd](../ToolandCommandReference/dsscmd.md)

## 依赖关系

无。

## 基本原理

在资源池化环境下，XLOG存储在共享日志盘内，配置了归档相关参数的主机会从共享盘内读取XLOG，然后判断是否需要归档，需要归档的触发条件是日志段发生切换，其中包有三种情况会切换日志段，一是用户调用pg_switch_xlog函数将强制切换日志段，二是正确插入日志情况下，如果超出了日志段的大小，也会切换日志段，三是如果超过了设定的时间（archive_timeout）而没有进行归档，则会做一次日志切换，强制归档。

主机在进行归档之前，在共享盘内归档状态文件夹中生成.ready文件来标记需要进行归档的XLOG，并且主机还会在归档进行完成后将该.ready文件重命名为.done，.done文件用来标记XLOG已归档完成。

主机在归档过程中会通过dsscmd工具，调用dss相关接口将XLOG拷贝至主机本地盘。

在PITR恢复过程中，主机会基于本地盘已连续归档的XLOG文件进行恢复。主机会将归档的XLOG拷贝至共享盘，然后通过回放XLOG的方式去进行恢复。

## 使用指导

XLOG归档部分仅archive\_command参数配置与传统主备有差异，其余参数配置限制与传统主备一致。参考[归档](../DatabaseReference/归档.md)使用指导。

PITR恢复部分参考[gs_probackup](../ToolandCommandReference/gs_probackup.md)使用指导
