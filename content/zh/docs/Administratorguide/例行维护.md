# 例行维护<a name="ZH-CN_TOPIC_0242215052"></a>

<!-- TOC -->

- [日维护检查项](#日维护检查项)
- [检查操作系统参数](#检查操作系统参数)
- [检查openGauss健康状态](#检查opengauss健康状态)
- [检查数据库性能](#检查数据库性能)
- [检查和清理日志](#检查和清理日志)
- [检查时间一致性](#检查时间一致性)
- [检查应用连接数](#检查应用连接数)
- [例行维护表](#例行维护表)
- [例行重建索引](#例行重建索引)
- [导出并查看WDR诊断报告](#导出并查看wdr诊断报告)
- [数据安全维护建议](#数据安全维护建议)
- [慢SQL诊断](#慢sql诊断)

<!-- /TOC -->


## 日维护检查项

### 检查openGauss状态<a name="zh-cn_topic_0237088794_zh-cn_topic_0059778434_sec4d5eda2fa542ba9fa77a1f284812ed"></a>

通过openGauss提供的工具查询数据库和实例状态，确认数据库和实例都处于正常的运行状态，可以对外提供数据服务。

-   检查实例状态

    ```
    gs_check -U omm -i CheckClusterState
    ```

- 检查参数

  ```
  openGauss=# SHOW parameter_name;
  ```

  上述命令中，parameter_name需替换成具体的参数名称。

-   修改参数

    ```
    gs_guc reload  -D /gaussdb/data/dbnode -c "paraname=value"
    ```


### 检查锁信息<a name="zh-cn_topic_0237088794_zh-cn_topic_0059778434_s8e22677f9faf4758ad39f7d6d1dde863"></a>

锁机制是数据库保证数据一致性的重要手段，检查相关信息可以检查数据库的事务和运行状况。

-   查询数据库中的锁信息

    ```
    openGauss=# SELECT * FROM pg_locks;
    ```

- 查询等待锁的线程状态信息

  ```
  openGauss=# SELECT * FROM pg_thread_wait_status WHERE wait_status = 'acquire lock';
  ```

  

-   结束系统进程

    查找正在运行的系统进程，然后使用kill命令结束此进程。

    ```
    ps ux
    kill -9 pid
    ```


### 统计事件数据<a name="zh-cn_topic_0237088794_zh-cn_topic_0059778434_s6506801e729943aba510e2fe669ad8a1"></a>

SQL语句长时间运行会占用大量系统资源，用户可以通过查看事件发生的时间，占用内存大小来了解现在数据库运行状态。

-   查询事件的时间

    查询事件的线程启动时间、事务启动时间、SQL启动时间以及状态变更时间。

    ```
    openGauss=# SELECT backend_start,xact_start,query_start,state_change FROM pg_stat_activity;
    ```

-   查询当前服务器的会话计数信息

    ```
    openGauss=# SELECT count(*) FROM pg_stat_activity;
    ```

-   查询系统级统计信息

    查询当前使用内存最多的会话信息。

    ```
    openGauss=# SELECT * FROM pv_session_memory_detail() ORDER BY usedsize desc limit 10;
    ```


### 对象检查<a name="zh-cn_topic_0237088794_zh-cn_topic_0059778434_s8dae86ca711b4f24a076b0cffaa04b97"></a>

表、索引、分区、约束等是数据库的核心存储对象，其核心信息和对象维护是DBA重要的日常工作。

-   查看表的详细信息

    ```
    openGauss=# \d+ table_name 
    ```

-   查询表统计信息

    ```
    openGauss=# SELECT * FROM pg_statistic;
    ```

-   查看索引的详细信息

    ```
    openGauss=# \d+ index_name
    ```

-   查询分区表信息

    ```
    openGauss=# SELECT * FROM pg_partition;
    ```

-   收集统计信息

    使用ANALYZE语句收集数据库相关的统计信息。

    使用VACUUM语句可以回收空间并更新统计信息。

-   查询约束信息

    ```
    openGauss=# SELECT * FROM pg_constraint;
    ```


### SQL报告检查<a name="zh-cn_topic_0237088794_zh-cn_topic_0059778434_sb5b215f4b4a6440c97da40f66359217d"></a>

使用EXPLAIN语句查看执行计划。

### 备份<a name="zh-cn_topic_0237088794_zh-cn_topic_0059778434_s66738f470526461eb7c137fbe0058c70"></a>

数据备份重于一切，日常应检查备份执行情况，并检查备份有效性，确保备份能够保障数据安全，备份安全加密也应兼顾。

-   指定用户导出数据库

    ```
    gs_dump dbname -p port -f out.sql -U user_name -W password
    ```

-   导出schema

    ```
    gs_dump dbname -p port -n schema_name -f out.sql
    ```

-   导出table

    ```
    gs_dump dbname -p port -t table_name -f out.sql
    ```


### 基本信息检查<a name="zh-cn_topic_0237088794_zh-cn_topic_0059778434_s35aa1e60db1042848a9f4f06413bcb4f"></a>

基本信息包括版本、组件、补丁集等信息，定期检查数据库信息并登记在案是数据库生命周期管理的重要内容之一。

-   版本信息

    ```
    openGauss=# SELECT version();
    ```

-   容量检查

    ```
    openGauss=# SELECT pg_table_size('table_name');
    openGauss=# SELECT pg_database_size('database_name');
    ```


## 检查操作系统参数

### 检查办法<a name="section5177032472"></a>

通过openGauss提供的gs\_checkos工具可以完成操作系统状态检查。

**前提条件**

-   当前的硬件和网络环境正常。
-   各主机间root互信状态正常。
-   只能使用root用户执行gs\_checkos命令。

**操作步骤**

1.  以root用户身份登录任意一台服务器。
2.  执行如下命令对openGauss节点服务器的OS参数进行检查。

    ```
    gs_checkos -i A
    ```

    检查节点服务器的OS参数的目的是保证openGauss正常通过预安装，并且在安装成功后可以安全高效的运行。详细的检查项目请参见《openGauss 工具参考》中“服务端工具 \> gs\_checkos”章节。


**示例**

执行gs\_checkos前需要先使用gs\_preinstall工具执行前置脚本，准备环境。以参数“A”为例。

```
gs_checkos -i A
Checking items:
    A1. [ OS version status ]                                   : Normal
    A2. [ Kernel version status ]                               : Normal
    A3. [ Unicode status ]                                      : Normal
    A4. [ Time zone status ]                                    : Normal
    A5. [ Swap memory status ]                                  : Normal
    A6. [ System control parameters status ]                    : Normal
    A7. [ File system configuration status ]                    : Normal
    A8. [ Disk configuration status ]                           : Normal
    A9. [ Pre-read block size status ]                          : Normal
    A10.[ IO scheduler status ]                                 : Normal
    A11.[ Network card configuration status ]                   : Normal
    A12.[ Time consistency status ]                             : Warning
    A13.[ Firewall service status ]                             : Normal
    A14.[ THP service status ]                                  : Normal
Total numbers:14. Abnormal numbers:0. Warning number:1.
```

以参数“B”为例。

```
gs_checkos -i B
Setting items:
    B1. [ Set system control parameters ]                       : Normal
    B2. [ Set file system configuration value ]                 : Normal
    B3. [ Set pre-read block size value ]                       : Normal
    B4. [ Set IO scheduler value ]                              : Normal
    B5. [ Set network card configuration value ]                : Normal
    B6. [ Set THP service ]                                     : Normal
    B7. [ Set RemoveIPC value ]                                 : Normal
    B8. [ Set Session Process ]                                 : Normal
Total numbers:6. Abnormal numbers:0. Warning number:0. 
```

### 异常处理<a name="section16612183634817"></a>

使用gs\_checkos检查openGauss状态，可以使用如下命令查看详细的错误信息。

```
gs_checkos -i A --detail
```

其中，Abnormal为必须处理项，影响openGauss安装。Warning可以不处理，不会影响openGauss安装。

-   如果操作系统版本（A1）检查项检查结果为Abnormal，需要将不属于混编范围的操作系统版本替换为混编范围内的操作系统版本。
-   如果内核版本（A2）检查项检查结果为Warning，则表示openGauss集群内操作系统平台的内核版本不一致。
-   如果Unicode状态（A3）检查项检查结果为Abnormal，需要将各主机的字符集设置为相同的字符集，可以在/etc/profile文件中添加“export LANG=XXX”（XXX为Unicode编码）。

    ```
    vim /etc/profile
    ```

-   如果时区状态（A4）检查项检查结果为Abnormal，需要将各主机的时区设置为相同时区，可以将/usr/share/zoneinfo/目录下的时区文件拷贝为/etc/localtime文件。

    ```
    cp /usr/share/zoneinfo/$主时区/$次时区 /etc/localtime
    ```

-   如果交换内存状态（A5）检查项检查结果为Abnormal，可能是因为Swap空间大于Mem空间，可减小Swap解决或者增大Mem空间解决。
-   如果系统控制参数（A6）检查项检查结果为Abnormal，可以使用以下两种方法进行设置。
    -   可以使用如下命令进行设置。

        ```
        gs_checkos -i B1
        ```

    -   根据错误提示信息，在/etc/sysctl.conf文件中进行设置。然后执行sysctl -p使其生效。

        ```
        vim /etc/sysctl.conf
        ```



-   如果文件系统配置状态（A7）检查项检查结果为Abnormal，可以使用如下命令进行设置。

    ```
    gs_checkos -i B2
    ```

-   如果磁盘配置状态（A8）检查项检查结果为Abnormal，需修改磁盘挂载格式为：“rw,noatime,inode64,allocsize=16m”。

    使用linux的man mount命令挂载XFS选项：

    ```
    rw,noatime,inode64,allocsize=16m
    ```

    也可以在/etc/fstab文件中设定XFS选项。如下示例：

    ```
    /dev/data /data xfs rw,noatime,inode64,allocsize=16m 0 0
    ```

-   如果预读块大小（A9）检查项检查结果为Abnormal，可以使用如下命令进行设置。

    ```
    gs_checkos -i B3
    ```

-   如果IO调度状态（A10）检查项检查结果为Abnormal，可以使用如下命令进行设置。

    ```
    gs_checkos -i B4
    ```


-   如果网卡配置状态（A11）检查项检查结果为Warning，可以使用如下命令进行设置。

    ```
    gs_checkos -i B5
    ```

-   如果时间一致性（A12）检查项检查结果为Abnormal，需检查是否安装ntp服务，以及ntp服务是否启动；并与ntp时钟源同步。
-   如果防火墙状态（A13）检查项检查结果为Abnormal，需关闭防火墙服务。使用如下命令进行设置。
    -   SuSE：

        ```
        SuSEfirewall2 stop
        ```

    -   RedHat7：

        ```
        systemctl disable firewalld
        systemctl stop firewalld
        ```

    -   RedHat6：

        ```
        service iptables stop
        ```


-   如果THP服务（A14）检查项检查结果为Abnormal，可以使用如下命令进行设置。

    ```
    gs_checkos -i B6
    ```


## 检查openGauss健康状态

### 检查办法<a name="section5333174013503"></a>

通过openGauss提供的gs\_check工具可以开展openGauss健康状态检查。

**注意事项**

-   扩容新节点检查只能在root用户下执行，其他场景都必须在omm用户下执行。
-   必须指定-i或-e参数，-i会检查指定的单项，-e会检查对应场景配置中的多项。
-   如果-i参数中不包含root类检查项或-e场景配置列表中没有root类检查项，则不需要交互输入root权限的用户及其密码。
-   可使用--skip-root-items跳过检查项中包含的root类检查，以免需要输入root权限用户及密码。
-   检查扩容新节点与现有节点之间的一致性，在现有节点执行gs\_check命令指定--hosts参数进行检查，其中hosts文件中需要写入新节点ip。

**操作步骤**

方式1：

1.  以操作系统用户omm登录数据库主节点。
2.  执行如下命令对openGauss数据库状态进行检查。

    ```
    gs_check -i CheckClusterState
    ```

    其中，-i指定检查项，注意区分大小写。格式：-i CheckClusterState、-i CheckCPU或-i CheckClusterState，CheckCPU。

    取值范围为所有支持的检查项名称，详细列表请参见《openGauss 工具参考》中“服务端工具 \> gs\_checkos \> openGauss状态检查表”，用户可以根据需求自己编写新检查项。


方式2：

1. 以操作系统用户omm登录数据库主节点。

2.  执行如下命令对openGauss数据库进行健康检查。

    ```
    gs_check -e inspect
    ```

    其中，-e指定场景名，注意区分大小写。格式：-e inspect或-e upgrade。

    取值范围为所有支持的巡检场景名称，默认列表包括：inspect（例行巡检）、upgrade（升级前巡检）、install（安装）、binary\_upgrade（就地升级前巡检）、health（健康检查巡检）、slow_node（节点）、longtime（耗时长巡检），用户可以根据需求自己编写场景。


openGauss巡检的主要作用是在openGauss运行过程中，检查整个openGauss状态是否正常，或者重大操作前（升级、扩容），确保openGauss满足操作所需的环境条件和状态条件。详细的巡检项目和场景请参见《openGauss 工具参考》中“服务端工具 \> gs\_checkos \> openGauss状态检查表”。

**示例**

执行单项检查结果：

```
perfadm@lfgp000700749:/opt/huawei/perfadm/tool/script> gs_check -i CheckCPU
Parsing the check items config file successfully
Distribute the context file to remote hosts successfully
Start to health check for the cluster. Total Items:1 Nodes:3

Checking...               [=========================] 1/1
Start to analysis the check result
CheckCPU....................................OK
The item run on 3 nodes.  success: 3

Analysis the check result successfully
Success. All check items run completed. Total:1  Success:1  Failed:0
For more information please refer to /opt/huawei/wisequery/script/gspylib/inspection/output/CheckReport_201902193704661604.tar.gz
```

本地执行结果：

```
perfadm@lfgp000700749:/opt/huawei/perfadm/tool/script> gs_check -i CheckCPU -L

2017-12-29 17:09:29 [NAM] CheckCPU
2017-12-29 17:09:29 [STD] 检查主机CPU占用率，如果idle 大于30%并且iowait 小于 30%.则检查项通过，否则检查项不通过
2017-12-29 17:09:29 [RST] OK

2017-12-29 17:09:29 [RAW]
Linux 4.4.21-69-default (lfgp000700749)  12/29/17  _x86_64_

17:09:24        CPU     %user     %nice   %system   %iowait    %steal     %idle
17:09:25        all      0.25      0.00      0.25      0.00      0.00     99.50
17:09:26        all      0.25      0.00      0.13      0.00      0.00     99.62
17:09:27        all      0.25      0.00      0.25      0.13      0.00     99.37
17:09:28        all      0.38      0.00      0.25      0.00      0.13     99.25
17:09:29        all      1.00      0.00      0.88      0.00      0.00     98.12
Average:        all      0.43      0.00      0.35      0.03      0.03     99.17
```

执行场景检查结果：

```
[perfadm@SIA1000131072 Check]$ gs_check -e inspect
Parsing the check items config file successfully
The below items require root privileges to execute:[CheckBlockdev CheckIOrequestqueue CheckIOConfigure CheckCheckMultiQueue CheckFirewall CheckSshdService CheckSshdConfig CheckCrondService CheckBootItems CheckFilehandle CheckNICModel CheckDropCache]
Please enter root privileges user[root]:root
Please enter password for user[root]:
Please enter password for user[root] on the node[10.244.57.240]:
Check root password connection successfully
Distribute the context file to remote hosts successfully
Start to health check for the cluster. Total Items:57 Nodes:2

Checking...               [                         ] 21/57
Checking...               [=========================] 57/57
Start to analysis the check result
CheckClusterState...........................OK
The item run on 2 nodes.  success: 2

CheckDBParams...............................OK
The item run on 1 nodes.  success: 1

CheckDebugSwitch............................OK
The item run on 2 nodes.  success: 2

CheckDirPermissions.........................OK
The item run on 2 nodes.  success: 2

CheckReadonlyMode...........................OK
The item run on 1 nodes.  success: 1

CheckEnvProfile.............................OK
The item run on 2 nodes.  success: 2  (consistent)
The success on all nodes value:
GAUSSHOME        /usr1/gaussdb/app
LD_LIBRARY_PATH  /usr1/gaussdb/app/lib
PATH             /usr1/gaussdb/app/bin


CheckBlockdev...............................OK
The item run on 2 nodes.  success: 2

CheckCurConnCount...........................OK
The item run on 1 nodes.  success: 1

CheckCursorNum..............................OK
The item run on 1 nodes.  success: 1

CheckPgxcgroup..............................OK
The item run on 1 nodes.  success: 1

CheckDiskFormat.............................OK
The item run on 2 nodes.  success: 2

CheckSpaceUsage.............................OK
The item run on 2 nodes.  success: 2

CheckInodeUsage.............................OK
The item run on 2 nodes.  success: 2

CheckSwapMemory.............................OK
The item run on 2 nodes.  success: 2

CheckLogicalBlock...........................OK
The item run on 2 nodes.  success: 2

CheckIOrequestqueue.....................WARNING
The item run on 2 nodes.  warning: 2
The warning[host240,host157] value:
On device (vdb) 'IO Request' RealValue '256' ExpectedValue '32768'
On device (vda) 'IO Request' RealValue '256' ExpectedValue '32768'

CheckMaxAsyIOrequests.......................OK
The item run on 2 nodes.  success: 2

CheckIOConfigure............................OK
The item run on 2 nodes.  success: 2

CheckMTU....................................OK
The item run on 2 nodes.  success: 2  (consistent)
The success on all nodes value:
1500

CheckPing...................................OK
The item run on 2 nodes.  success: 2

CheckRXTX...................................NG
The item run on 2 nodes.  ng: 2
The ng[host240,host157] value:
NetWork[eth0]
RX: 256
TX: 256


CheckNetWorkDrop............................OK
The item run on 2 nodes.  success: 2

CheckMultiQueue.............................OK
The item run on 2 nodes.  success: 2

CheckEncoding...............................OK
The item run on 2 nodes.  success: 2  (consistent)
The success on all nodes value:
LANG=en_US.UTF-8

CheckFirewall...............................OK
The item run on 2 nodes.  success: 2

CheckKernelVer..............................OK
The item run on 2 nodes.  success: 2  (consistent)
The success on all nodes value:
3.10.0-957.el7.x86_64 

CheckMaxHandle..............................OK
The item run on 2 nodes.  success: 2

CheckNTPD...................................OK
host240: NTPD service is running, 2020-06-02 17:00:28
host157: NTPD service is running, 2020-06-02 17:00:06


CheckOSVer..................................OK
host240: The current OS is centos 7.6 64bit.
host157: The current OS is centos 7.6 64bit.


CheckSysParams..........................WARNING
The item run on 2 nodes.  warning: 2
The warning[host240,host157] value:
Warning reason: variable 'net.ipv4.tcp_retries1' RealValue '3' ExpectedValue '5'.
Warning reason: variable 'net.ipv4.tcp_syn_retries' RealValue '6' ExpectedValue '5'.


CheckTHP....................................OK
The item run on 2 nodes.  success: 2

CheckTimeZone...............................OK
The item run on 2 nodes.  success: 2  (consistent)
The success on all nodes value:
+0800

CheckCPU....................................OK
The item run on 2 nodes.  success: 2

CheckSshdService............................OK
The item run on 2 nodes.  success: 2

Warning reason: UseDNS parameter is not set; expected: no

CheckCrondService...........................OK
The item run on 2 nodes.  success: 2

CheckStack..................................OK
The item run on 2 nodes.  success: 2  (consistent)
The success on all nodes value:
8192

CheckSysPortRange...........................OK
The item run on 2 nodes.  success: 2

CheckMemInfo................................OK
The item run on 2 nodes.  success: 2  (consistent)
The success on all nodes value:
totalMem: 31.260929107666016G

CheckHyperThread............................OK
The item run on 2 nodes.  success: 2

CheckTableSpace.............................OK
The item run on 1 nodes.  success: 1


CheckSysadminUser...........................OK
The item run on 1 nodes.  success: 1


CheckGUCConsistent..........................OK
All DN instance guc value is consistent.

CheckMaxProcMemory..........................OK
The item run on 1 nodes.  success: 1

CheckBootItems..............................OK
The item run on 2 nodes.  success: 2

CheckHashIndex..............................OK
The item run on 1 nodes.  success: 1

CheckPgxcRedistb............................OK
The item run on 1 nodes.  success: 1

CheckNodeGroupName..........................OK
The item run on 1 nodes.  success: 1

CheckTDDate.................................OK
The item run on 1 nodes.  success: 1

CheckDilateSysTab...........................OK
The item run on 1 nodes.  success: 1

CheckKeyProAdj..............................OK
The item run on 2 nodes.  success: 2

CheckProStartTime.......................WARNING
host157:
STARTED COMMAND
Tue Jun  2 16:57:18 2020 /usr1/dmuser/dmserver/metricdb1/server/bin/gaussdb --single_node -D /usr1/dmuser/dmb1/data -p 22204
Mon Jun  1 16:15:15 2020 /usr1/gaussdb/app/bin/gaussdb -D /usr1/gaussdb/data/dn1 -M standby


CheckFilehandle.............................OK
The item run on 2 nodes.  success: 2

CheckRouting................................OK
The item run on 2 nodes.  success: 2

CheckNICModel...............................OK
The item run on 2 nodes.  success: 2  (consistent)
The success on all nodes value:
version: 1.0.1
model: Red Hat, Inc. Virtio network device


CheckDropCache..........................WARNING
The item run on 2 nodes.  warning: 2
The warning[host240,host157] value:
No DropCache process is running

CheckMpprcFile..............................NG
The item run on 2 nodes.  ng: 2
The ng[host240,host157] value:
There is no mpprc file

Analysis the check result successfully
Failed. All check items run completed. Total:57   Success:50   Warning:5   NG:2
For more information please refer to /usr1/gaussdb/tool/script/gspylib/inspection/output/CheckReport_inspect611.tar.gz

```

### 异常处理<a name="section104101932312"></a>

如果发现检查结果异常，可以根据以下内容进行修复。

**表 1**  检查openGauss运行状态

<a name="zh-cn_topic_0237088800_t839e243ba9874e4d89255e791cd15811"></a>
<table><thead align="left"><tr id="zh-cn_topic_0237088800_rb4ac09be678a4c478332b72fc54c86da"><th class="cellrowborder" valign="top" width="20.59%" id="mcps1.2.4.1.1"><p id="zh-cn_topic_0237088800_a924b3b3672d54860a521ec49bc2c2b3a"><a name="zh-cn_topic_0237088800_a924b3b3672d54860a521ec49bc2c2b3a"></a><a name="zh-cn_topic_0237088800_a924b3b3672d54860a521ec49bc2c2b3a"></a>检查项</p>
</th>
<th class="cellrowborder" valign="top" width="22.21%" id="mcps1.2.4.1.2"><p id="zh-cn_topic_0237088800_ade62aaa16c324c4eadf75810f4af912d"><a name="zh-cn_topic_0237088800_ade62aaa16c324c4eadf75810f4af912d"></a><a name="zh-cn_topic_0237088800_ade62aaa16c324c4eadf75810f4af912d"></a>异常状态</p>
</th>
<th class="cellrowborder" valign="top" width="57.199999999999996%" id="mcps1.2.4.1.3"><p id="zh-cn_topic_0237088800_a52bda49fcd244ef18115c4f5ffd4269e"><a name="zh-cn_topic_0237088800_a52bda49fcd244ef18115c4f5ffd4269e"></a><a name="zh-cn_topic_0237088800_a52bda49fcd244ef18115c4f5ffd4269e"></a>处理方法</p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0237088800_r8b77c6ca6c9d48cebfe2154085166c41"><td class="cellrowborder" rowspan="2" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_zh-cn_topic_0058967589_p652816918481"><a name="zh-cn_topic_0237088800_zh-cn_topic_0058967589_p652816918481"></a><a name="zh-cn_topic_0237088800_zh-cn_topic_0058967589_p652816918481"></a>CheckClusterState（检查openGauss状态）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_adce0fa99543c4cafbe1a80d682dd4528"><a name="zh-cn_topic_0237088800_adce0fa99543c4cafbe1a80d682dd4528"></a><a name="zh-cn_topic_0237088800_adce0fa99543c4cafbe1a80d682dd4528"></a>openGauss未启动或openGauss实例未启动</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_a7af774e26cbc4ee2a375102e289cdb60"><a name="zh-cn_topic_0237088800_a7af774e26cbc4ee2a375102e289cdb60"></a><a name="zh-cn_topic_0237088800_a7af774e26cbc4ee2a375102e289cdb60"></a>使用以下命令启动openGauss及实例。</p>
<pre class="screen" id="zh-cn_topic_0237088800_scb4745d1e0354b08964cb64059269abd"><a name="zh-cn_topic_0237088800_scb4745d1e0354b08964cb64059269abd"></a><a name="zh-cn_topic_0237088800_scb4745d1e0354b08964cb64059269abd"></a><strong id="zh-cn_topic_0237088800_a18f6635d1e9247cd8c4429dd314e0da8"><a name="zh-cn_topic_0237088800_a18f6635d1e9247cd8c4429dd314e0da8"></a><a name="zh-cn_topic_0237088800_a18f6635d1e9247cd8c4429dd314e0da8"></a>gs_om -t start</strong></pre>
</td>
</tr>
<tr id="zh-cn_topic_0237088800_r995473b742fe4e7298afcde8548fab89"><td class="cellrowborder" valign="top" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_a8100a17bcc1543efab3afbd108d4f8fa"><a name="zh-cn_topic_0237088800_a8100a17bcc1543efab3afbd108d4f8fa"></a><a name="zh-cn_topic_0237088800_a8100a17bcc1543efab3afbd108d4f8fa"></a>openGauss状态异常或openGauss实例异常</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_ac076faacd5a94c7999c39d9137fa28da"><a name="zh-cn_topic_0237088800_ac076faacd5a94c7999c39d9137fa28da"></a><a name="zh-cn_topic_0237088800_ac076faacd5a94c7999c39d9137fa28da"></a>检查各主机、实例状态，根据状态信息进行排查。</p>
<pre class="screen" id="zh-cn_topic_0237088800_sb2a81ac8ce9d43d186b7df97a888b807"><a name="zh-cn_topic_0237088800_sb2a81ac8ce9d43d186b7df97a888b807"></a><a name="zh-cn_topic_0237088800_sb2a81ac8ce9d43d186b7df97a888b807"></a><strong id="zh-cn_topic_0237088800_abc737b2279a4431c8c128ae587004994"><a name="zh-cn_topic_0237088800_abc737b2279a4431c8c128ae587004994"></a><a name="zh-cn_topic_0237088800_abc737b2279a4431c8c128ae587004994"></a>gs_check -i CheckClusterState</strong></pre>
</td>
</tr>
<tr id="zh-cn_topic_0237088800_r86a2ced234c842c7be39c3323a7fb3a6"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p83146282381"><a name="zh-cn_topic_0237088800_p83146282381"></a><a name="zh-cn_topic_0237088800_p83146282381"></a>CheckDBParams（检查数据库参数）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p1631619281380"><a name="zh-cn_topic_0237088800_p1631619281380"></a><a name="zh-cn_topic_0237088800_p1631619281380"></a>数据库参数错误</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p1731892810380"><a name="zh-cn_topic_0237088800_p1731892810380"></a><a name="zh-cn_topic_0237088800_p1731892810380"></a>通过gs_guc工具修改数据库参数为指定值。</p>
</td>
</tr>
<tr id="zh-cn_topic_0237088800_row195311634103914"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p14912850123913"><a name="zh-cn_topic_0237088800_p14912850123913"></a><a name="zh-cn_topic_0237088800_p14912850123913"></a>CheckDebugSwitch（检查调试日志）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p1591345053914"><a name="zh-cn_topic_0237088800_p1591345053914"></a><a name="zh-cn_topic_0237088800_p1591345053914"></a>日志级别不正确</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p16915155023918"><a name="zh-cn_topic_0237088800_p16915155023918"></a><a name="zh-cn_topic_0237088800_p16915155023918"></a>使用gs_guc工具将log_min_messages改为指定内容。</p>
</td>
</tr>
<tr id="zh-cn_topic_0237088800_row6896171624012"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p788611257409"><a name="zh-cn_topic_0237088800_p788611257409"></a><a name="zh-cn_topic_0237088800_p788611257409"></a>CheckDirPermissions（检查目录权限）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p108891525124013"><a name="zh-cn_topic_0237088800_p108891525124013"></a><a name="zh-cn_topic_0237088800_p108891525124013"></a>路径权限错误</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p489262512403"><a name="zh-cn_topic_0237088800_p489262512403"></a><a name="zh-cn_topic_0237088800_p489262512403"></a>修改对应目录权限为指定数值（750/700）。</p>
<pre class="screen" id="zh-cn_topic_0237088800_screen15893132512404"><a name="zh-cn_topic_0237088800_screen15893132512404"></a><a name="zh-cn_topic_0237088800_screen15893132512404"></a><strong id="zh-cn_topic_0237088800_b289782504019"><a name="zh-cn_topic_0237088800_b289782504019"></a><a name="zh-cn_topic_0237088800_b289782504019"></a>chmod 700 </strong><em id="zh-cn_topic_0237088800_i12898162514408"><a name="zh-cn_topic_0237088800_i12898162514408"></a><a name="zh-cn_topic_0237088800_i12898162514408"></a>DIR</em></pre>
</td>
</tr>
<tr id="zh-cn_topic_0237088800_row119998504408"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p79996504406"><a name="zh-cn_topic_0237088800_p79996504406"></a><a name="zh-cn_topic_0237088800_p79996504406"></a>CheckReadonlyMode（检查只读模式）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p1499919508407"><a name="zh-cn_topic_0237088800_p1499919508407"></a><a name="zh-cn_topic_0237088800_p1499919508407"></a>只读模式被打开</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p64041033184214"><a name="zh-cn_topic_0237088800_p64041033184214"></a><a name="zh-cn_topic_0237088800_p64041033184214"></a>确认<span id="zh-cn_topic_0237088800_text1114721213115"><a name="zh-cn_topic_0237088800_text1114721213115"></a><a name="zh-cn_topic_0237088800_text1114721213115"></a>数据库节点</span>所在磁盘使用率未超阈值（默认85%）且未在执行其他运维操作。</p>
<pre class="screen" id="zh-cn_topic_0237088800_screen621121517448"><a name="zh-cn_topic_0237088800_screen621121517448"></a><a name="zh-cn_topic_0237088800_screen621121517448"></a><strong id="zh-cn_topic_0237088800_b84701622114417"><a name="zh-cn_topic_0237088800_b84701622114417"></a><a name="zh-cn_topic_0237088800_b84701622114417"></a>gs_check -i CheckDataDiskUsage</strong>
<strong id="zh-cn_topic_0237088800_b18729929104417"><a name="zh-cn_topic_0237088800_b18729929104417"></a><a name="zh-cn_topic_0237088800_b18729929104417"></a>ps ux</strong></pre>
<p id="zh-cn_topic_0237088800_p09991650174014"><a name="zh-cn_topic_0237088800_p09991650174014"></a><a name="zh-cn_topic_0237088800_p09991650174014"></a>使用gs_guc工具关闭openGauss只读模式。</p>
<pre class="screen" id="zh-cn_topic_0237088800_screen6249173144516"><a name="zh-cn_topic_0237088800_screen6249173144516"></a><a name="zh-cn_topic_0237088800_screen6249173144516"></a><strong id="zh-cn_topic_0237088800_b153715124518"><a name="zh-cn_topic_0237088800_b153715124518"></a><a name="zh-cn_topic_0237088800_b153715124518"></a>gs_guc reload -N all -I all -c 'default_transaction_read_only = off' </strong>
<tr id="zh-cn_topic_0237088800_row599175395319"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p510012536530"><a name="zh-cn_topic_0237088800_p510012536530"></a><a name="zh-cn_topic_0237088800_p510012536530"></a>CheckEnvProfile（检查环境变量）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p110005325316"><a name="zh-cn_topic_0237088800_p110005325316"></a><a name="zh-cn_topic_0237088800_p110005325316"></a>环境变量不一致</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p610055310537"><a name="zh-cn_topic_0237088800_p610055310537"></a><a name="zh-cn_topic_0237088800_p610055310537"></a>重新执行前置更新环境变量信息。</p>
</td>
</tr>
<tr id="zh-cn_topic_0237088800_row163163045510"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p1763115309555"><a name="zh-cn_topic_0237088800_p1763115309555"></a><a name="zh-cn_topic_0237088800_p1763115309555"></a>CheckBlockdev（检查磁盘预读块）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p6631103017557"><a name="zh-cn_topic_0237088800_p6631103017557"></a><a name="zh-cn_topic_0237088800_p6631103017557"></a>磁盘预读块大小不为16384</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p19256111175917"><a name="zh-cn_topic_0237088800_p19256111175917"></a><a name="zh-cn_topic_0237088800_p19256111175917"></a>使用gs_checkos设置预读块大小为16384KB，并写入自启动文件。</p>
<pre class="screen" id="zh-cn_topic_0237088800_screen24791715195913"><a name="zh-cn_topic_0237088800_screen24791715195913"></a><a name="zh-cn_topic_0237088800_screen24791715195913"></a><strong id="zh-cn_topic_0237088800_a37f4b6b7e9f84721a79b514c47f7bd09"><a name="zh-cn_topic_0237088800_a37f4b6b7e9f84721a79b514c47f7bd09"></a><a name="zh-cn_topic_0237088800_a37f4b6b7e9f84721a79b514c47f7bd09"></a>gs_checkos -i B3</strong></pre>
</td>
</tr>
<tr id="zh-cn_topic_0237088800_row5347173192514"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p153487314252"><a name="zh-cn_topic_0237088800_p153487314252"></a><a name="zh-cn_topic_0237088800_p153487314252"></a>CheckCursorNum（检查游标数）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p193481537259"><a name="zh-cn_topic_0237088800_p193481537259"></a><a name="zh-cn_topic_0237088800_p193481537259"></a>检查游标数失败</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p3348731258"><a name="zh-cn_topic_0237088800_p3348731258"></a><a name="zh-cn_topic_0237088800_p3348731258"></a>检查数据库能否正常连接，openGauss状态是否正常。</p>
</td>
</tr>
<tr id="zh-cn_topic_0237088800_row75161117123413"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p10517617103418"><a name="zh-cn_topic_0237088800_p10517617103418"></a><a name="zh-cn_topic_0237088800_p10517617103418"></a>CheckPgxcgroup（检查重分布状态）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p1551710176342"><a name="zh-cn_topic_0237088800_p1551710176342"></a><a name="zh-cn_topic_0237088800_p1551710176342"></a>有未完成重分布的pgxc_group表</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p1451771773411"><a name="zh-cn_topic_0237088800_p1451771773411"></a><a name="zh-cn_topic_0237088800_p1451771773411"></a>继续完成扩容或缩容的数据重分布操作。</p>
<pre class="screen" id="zh-cn_topic_0237088800_screen1876573389"><a name="zh-cn_topic_0237088800_screen1876573389"></a><a name="zh-cn_topic_0237088800_screen1876573389"></a><strong id="zh-cn_topic_0237088800_b4509810142511"><a name="zh-cn_topic_0237088800_b4509810142511"></a><a name="zh-cn_topic_0237088800_b4509810142511"></a>gs_expand、gs_shrink</strong></pre>
</td>
</tr>
<tr id="zh-cn_topic_0237088800_row6380929143913"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p83803290393"><a name="zh-cn_topic_0237088800_p83803290393"></a><a name="zh-cn_topic_0237088800_p83803290393"></a>CheckDiskFormat（检查磁盘配置）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p193801629163912"><a name="zh-cn_topic_0237088800_p193801629163912"></a><a name="zh-cn_topic_0237088800_p193801629163912"></a>各节点磁盘配置不一致</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p103802298398"><a name="zh-cn_topic_0237088800_p103802298398"></a><a name="zh-cn_topic_0237088800_p103802298398"></a>将各节点的磁盘规格改为相同。</p>
</td>
</tr>
<tr id="zh-cn_topic_0237088800_row7657194664218"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p965714465429"><a name="zh-cn_topic_0237088800_p965714465429"></a><a name="zh-cn_topic_0237088800_p965714465429"></a>CheckSpaceUsage（检查磁盘空间使用率）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p265724624220"><a name="zh-cn_topic_0237088800_p265724624220"></a><a name="zh-cn_topic_0237088800_p265724624220"></a>磁盘可用空间不足</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p16657204654216"><a name="zh-cn_topic_0237088800_p16657204654216"></a><a name="zh-cn_topic_0237088800_p16657204654216"></a>清理或扩展对应目录所在的磁盘。</p>
</td>
</tr>
<tr id="zh-cn_topic_0237088800_row171664210433"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p4717124284316"><a name="zh-cn_topic_0237088800_p4717124284316"></a><a name="zh-cn_topic_0237088800_p4717124284316"></a>CheckInodeUsage（检查磁盘索引使用率）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p167170425439"><a name="zh-cn_topic_0237088800_p167170425439"></a><a name="zh-cn_topic_0237088800_p167170425439"></a>磁盘可用索引不足</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p87171742144316"><a name="zh-cn_topic_0237088800_p87171742144316"></a><a name="zh-cn_topic_0237088800_p87171742144316"></a>清理或扩展对应目录所在的磁盘。</p>
</td>
</tr>
<tr id="zh-cn_topic_0237088800_row15876182315493"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p1187710234491"><a name="zh-cn_topic_0237088800_p1187710234491"></a><a name="zh-cn_topic_0237088800_p1187710234491"></a>CheckSwapMemory（检查交换内存）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p178771423144911"><a name="zh-cn_topic_0237088800_p178771423144911"></a><a name="zh-cn_topic_0237088800_p178771423144911"></a>交换内存大于物理内存</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p787872315497"><a name="zh-cn_topic_0237088800_p787872315497"></a><a name="zh-cn_topic_0237088800_p787872315497"></a>将交换内存调小或关闭。</p>
</td>
</tr>
<tr id="zh-cn_topic_0237088800_row196971126135019"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p196971526205014"><a name="zh-cn_topic_0237088800_p196971526205014"></a><a name="zh-cn_topic_0237088800_p196971526205014"></a>CheckLogicalBlock（检查磁盘逻辑块）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p1697626125016"><a name="zh-cn_topic_0237088800_p1697626125016"></a><a name="zh-cn_topic_0237088800_p1697626125016"></a>磁盘逻辑块大小不为512</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p769712685010"><a name="zh-cn_topic_0237088800_p769712685010"></a><a name="zh-cn_topic_0237088800_p769712685010"></a>使用gs_checkos修改磁盘逻辑块大小为512KB，并写入开机自启动文件。</p>
<pre class="screen" id="zh-cn_topic_0237088800_screen1815815388527"><a name="zh-cn_topic_0237088800_screen1815815388527"></a><a name="zh-cn_topic_0237088800_screen1815815388527"></a><strong id="zh-cn_topic_0237088800_a4d1dd9b1c51c4ef7b4de4915301fba89"><a name="zh-cn_topic_0237088800_a4d1dd9b1c51c4ef7b4de4915301fba89"></a><a name="zh-cn_topic_0237088800_a4d1dd9b1c51c4ef7b4de4915301fba89"></a>gs_checkos -i B4</strong></pre>
</td>
</tr>
<tr id="row95688271410"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p166371019544"><a name="zh-cn_topic_0237088800_p166371019544"></a><a name="zh-cn_topic_0237088800_p166371019544"></a>CheckIOrequestqueue（检查IO请求）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p19663310115419"><a name="zh-cn_topic_0237088800_p19663310115419"></a><a name="zh-cn_topic_0237088800_p19663310115419"></a>IO请求值不为32768</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p1466351016543"><a name="zh-cn_topic_0237088800_p1466351016543"></a><a name="zh-cn_topic_0237088800_p1466351016543"></a>使用gs_checkos设置IO请求值为32768，并写入开机自启动文件。</p>
<pre class="screen" id="zh-cn_topic_0237088800_screen1411998114112"><a name="zh-cn_topic_0237088800_screen1411998114112"></a><a name="zh-cn_topic_0237088800_screen1411998114112"></a><strong id="zh-cn_topic_0237088800_b16986193163018"><a name="zh-cn_topic_0237088800_b16986193163018"></a><a name="zh-cn_topic_0237088800_b16986193163018"></a>gs_checkos -i B4</strong></pre>
</td>
</tr>
<tr id="row656852712410"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p6321192515557"><a name="zh-cn_topic_0237088800_p6321192515557"></a><a name="zh-cn_topic_0237088800_p6321192515557"></a>CheckCurConnCount（检查当前连接数）111</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p10157112913249"><a name="zh-cn_topic_0237088800_p10157112913249"></a><a name="zh-cn_topic_0237088800_p10157112913249"></a>当前连接数超过最大连接数的90%</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p7321725125516"><a name="zh-cn_topic_0237088800_p7321725125516"></a><a name="zh-cn_topic_0237088800_p7321725125516"></a>断开未使用的<span id="zh-cn_topic_0237088800_text17990203920177"><a name="zh-cn_topic_0237088800_text17990203920177"></a><a name="zh-cn_topic_0237088800_text17990203920177"></a>数据库主节点</span>连接。</p>
</td>
</tr>
<tr id="row2567192717414"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p889115284112"><a name="zh-cn_topic_0237088800_p889115284112"></a><a name="zh-cn_topic_0237088800_p889115284112"></a>CheckMaxAsyIOrequests（检查最大异步请求）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p4891195294115"><a name="zh-cn_topic_0237088800_p4891195294115"></a><a name="zh-cn_topic_0237088800_p4891195294115"></a>最大异步请求值小于104857600或当前节点<span id="zh-cn_topic_0237088800_text4117182533110"><a name="zh-cn_topic_0237088800_text4117182533110"></a><a name="zh-cn_topic_0237088800_text4117182533110"></a>数据库</span>实例数乘以1048576</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p989115526414"><a name="zh-cn_topic_0237088800_p989115526414"></a><a name="zh-cn_topic_0237088800_p989115526414"></a>使用gs_checkos设置最大异步请求值为104857600和当前节点数据库实例数乘以1048576中的最大值。</p>
<pre class="screen" id="zh-cn_topic_0237088800_screen16746775301"><a name="zh-cn_topic_0237088800_screen16746775301"></a><a name="zh-cn_topic_0237088800_screen16746775301"></a><strong id="zh-cn_topic_0237088800_b47501716309"><a name="zh-cn_topic_0237088800_b47501716309"></a><a name="zh-cn_topic_0237088800_b47501716309"></a>gs_checkos -i B4</strong></pre>
</td>
</tr>
<tr id="row135673271943"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p1270033625"><a name="zh-cn_topic_0237088800_p1270033625"></a><a name="zh-cn_topic_0237088800_p1270033625"></a>CheckMTU（检查MTU值）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p1070016317217"><a name="zh-cn_topic_0237088800_p1070016317217"></a><a name="zh-cn_topic_0237088800_p1070016317217"></a>MTU值不一致</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p177001310218"><a name="zh-cn_topic_0237088800_p177001310218"></a><a name="zh-cn_topic_0237088800_p177001310218"></a>设置各节点的MTU一致为1500或8192。</p>
<pre class="screen" id="zh-cn_topic_0237088800_screen1517605014217"><a name="zh-cn_topic_0237088800_screen1517605014217"></a><a name="zh-cn_topic_0237088800_screen1517605014217"></a>ifconfig eth* MTU 1500</pre>
</td>
</tr>
<tr id="row1756718279414"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p092171819586"><a name="zh-cn_topic_0237088800_p092171819586"></a><a name="zh-cn_topic_0237088800_p092171819586"></a>CheckIOConfigure（检查IO配置）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p20921181811582"><a name="zh-cn_topic_0237088800_p20921181811582"></a><a name="zh-cn_topic_0237088800_p20921181811582"></a>IO配置不是deadline</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p792131875810"><a name="zh-cn_topic_0237088800_p792131875810"></a><a name="zh-cn_topic_0237088800_p792131875810"></a>使用gs_checkos设置IO配置为deadline，并写入开机自启动文件。</p>
<pre class="screen" id="zh-cn_topic_0237088800_screen12875105016019"><a name="zh-cn_topic_0237088800_screen12875105016019"></a><a name="zh-cn_topic_0237088800_screen12875105016019"></a><strong id="zh-cn_topic_0237088800_b1367013423017"><a name="zh-cn_topic_0237088800_b1367013423017"></a><a name="zh-cn_topic_0237088800_b1367013423017"></a>gs_checkos -i B4</strong></pre>
</td>
</tr>
<tr id="row1956718274418"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p895792513410"><a name="zh-cn_topic_0237088800_p895792513410"></a><a name="zh-cn_topic_0237088800_p895792513410"></a>CheckRXTX（检查RXTX值）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p17957192511413"><a name="zh-cn_topic_0237088800_p17957192511413"></a><a name="zh-cn_topic_0237088800_p17957192511413"></a>网卡RX/TX值不是4096</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p109571825345"><a name="zh-cn_topic_0237088800_p109571825345"></a><a name="zh-cn_topic_0237088800_p109571825345"></a>使用checkos设置openGauss使用的物理网卡RX/TX值为4096。</p>
<pre class="screen" id="zh-cn_topic_0237088800_screen91015216301"><a name="zh-cn_topic_0237088800_screen91015216301"></a><a name="zh-cn_topic_0237088800_screen91015216301"></a><strong id="zh-cn_topic_0237088800_b111316521305"><a name="zh-cn_topic_0237088800_b111316521305"></a><a name="zh-cn_topic_0237088800_b111316521305"></a>gs_checkos -i B5</strong></pre>
</td>
</tr>
<tr id="row125664272043"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p030101117314"><a name="zh-cn_topic_0237088800_p030101117314"></a><a name="zh-cn_topic_0237088800_p030101117314"></a>CheckPing（检查网络通畅）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p19301711537"><a name="zh-cn_topic_0237088800_p19301711537"></a><a name="zh-cn_topic_0237088800_p19301711537"></a>存在openGauss IP无法ping通</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p183011115316"><a name="zh-cn_topic_0237088800_p183011115316"></a><a name="zh-cn_topic_0237088800_p183011115316"></a>检查异常ip间网络设置和状态、防火墙状态。</p>
</td>
</tr>
<tr id="row185662273418"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p123325551256"><a name="zh-cn_topic_0237088800_p123325551256"></a><a name="zh-cn_topic_0237088800_p123325551256"></a>CheckNetWorkDrop（检查网络丢包率）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p1433213554512"><a name="zh-cn_topic_0237088800_p1433213554512"></a><a name="zh-cn_topic_0237088800_p1433213554512"></a>网络通信丢包率高于1%</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p73324555514"><a name="zh-cn_topic_0237088800_p73324555514"></a><a name="zh-cn_topic_0237088800_p73324555514"></a>检查对应IP间网络负载、状态。</p>
</td>
</tr>
<tr id="row956618273414"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p16244071074"><a name="zh-cn_topic_0237088800_p16244071074"></a><a name="zh-cn_topic_0237088800_p16244071074"></a>CheckMultiQueue（检查网卡多队列）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p1424418712712"><a name="zh-cn_topic_0237088800_p1424418712712"></a><a name="zh-cn_topic_0237088800_p1424418712712"></a>未开启网卡多队列并未将网卡中断绑定到不同CPU核心</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p192441273720"><a name="zh-cn_topic_0237088800_p192441273720"></a><a name="zh-cn_topic_0237088800_p192441273720"></a>开启网卡多队列并将网卡队列中断绑定到不同的CPU核心。</p>
</td>
</tr>
<tr id="row1756614275411"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p103129812811"><a name="zh-cn_topic_0237088800_p103129812811"></a><a name="zh-cn_topic_0237088800_p103129812811"></a>CheckEncoding（检查编码格式）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p1312082085"><a name="zh-cn_topic_0237088800_p1312082085"></a><a name="zh-cn_topic_0237088800_p1312082085"></a>各节点编码格式不一致</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p53121581783"><a name="zh-cn_topic_0237088800_p53121581783"></a><a name="zh-cn_topic_0237088800_p53121581783"></a>在/etc/profile中写入一致的编码信息。</p>
<pre class="screen" id="zh-cn_topic_0237088800_screen139872252911"><a name="zh-cn_topic_0237088800_screen139872252911"></a><a name="zh-cn_topic_0237088800_screen139872252911"></a><strong id="zh-cn_topic_0237088800_b69061554381"><a name="zh-cn_topic_0237088800_b69061554381"></a><a name="zh-cn_topic_0237088800_b69061554381"></a>echo "export LANG=XXX" &gt;&gt; /etc/profile</strong></pre>
</td>
</tr>
<tr id="row256512272417"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p43016891011"><a name="zh-cn_topic_0237088800_p43016891011"></a><a name="zh-cn_topic_0237088800_p43016891011"></a>CheckFirewall（检查防火墙）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p17304812106"><a name="zh-cn_topic_0237088800_p17304812106"></a><a name="zh-cn_topic_0237088800_p17304812106"></a>防火墙未关闭</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p0309814102"><a name="zh-cn_topic_0237088800_p0309814102"></a><a name="zh-cn_topic_0237088800_p0309814102"></a>关闭防火墙服务。</p>
<pre class="screen" id="zh-cn_topic_0237088800_screen168681239101015"><a name="zh-cn_topic_0237088800_screen168681239101015"></a><a name="zh-cn_topic_0237088800_screen168681239101015"></a><strong id="zh-cn_topic_0237088800_b13971145173814"><a name="zh-cn_topic_0237088800_b13971145173814"></a><a name="zh-cn_topic_0237088800_b13971145173814"></a>systemctl disable firewalld.service</strong>
<strong id="zh-cn_topic_0237088800_b13971145173814"><a name="zh-cn_topic_0237088800_b13971145173814"></a><a name="zh-cn_topic_0237088800_b13971145173814"></a>systemctl stop firewalld.service</strong>
<tr id="row1656512271841"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p171362517162"><a name="zh-cn_topic_0237088800_p171362517162"></a><a name="zh-cn_topic_0237088800_p171362517162"></a>CheckMaxHandle（检查最大文件句柄数）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p1513122561610"><a name="zh-cn_topic_0237088800_p1513122561610"></a><a name="zh-cn_topic_0237088800_p1513122561610"></a>最大文件句柄数小于1000000</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p213202561616"><a name="zh-cn_topic_0237088800_p213202561616"></a><a name="zh-cn_topic_0237088800_p213202561616"></a>设置91-nofile.conf/90-nofile.conf最大文件句柄数软硬限制为1000000。</p>
<pre class="screen" id="zh-cn_topic_0237088800_screen1968194271716"><a name="zh-cn_topic_0237088800_screen1968194271716"></a><a name="zh-cn_topic_0237088800_screen1968194271716"></a><strong id="zh-cn_topic_0237088800_a5744208a05614a3aa44d63fb9ae29de9"><a name="zh-cn_topic_0237088800_a5744208a05614a3aa44d63fb9ae29de9"></a><a name="zh-cn_topic_0237088800_a5744208a05614a3aa44d63fb9ae29de9"></a>gs_checkos -i B2</strong></pre>
</td>
</tr>
<tr id="row145641827842"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p1910456112311"><a name="zh-cn_topic_0237088800_p1910456112311"></a><a name="zh-cn_topic_0237088800_p1910456112311"></a>CheckNTPD（检查时间同步服务）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p8101756122319"><a name="zh-cn_topic_0237088800_p8101756122319"></a><a name="zh-cn_topic_0237088800_p8101756122319"></a>NTPD服务未开启或时间误差超过一分钟</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p17101856122313"><a name="zh-cn_topic_0237088800_p17101856122313"></a><a name="zh-cn_topic_0237088800_p17101856122313"></a>开启NTPD服务并设置时钟一致。</p>
</td>
</tr>
<tr id="row59673412512"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p31811427183514"><a name="zh-cn_topic_0237088800_p31811427183514"></a><a name="zh-cn_topic_0237088800_p31811427183514"></a>CheckSysParams（检查操作系统参数）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p618112271359"><a name="zh-cn_topic_0237088800_p618112271359"></a><a name="zh-cn_topic_0237088800_p618112271359"></a>操作系统参数设置不满足要求</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p13181827103517"><a name="zh-cn_topic_0237088800_p13181827103517"></a><a name="zh-cn_topic_0237088800_p13181827103517"></a>使用gs_checkos进行参数设置或手动设置。</p>
<pre class="screen" id="zh-cn_topic_0237088800_screen6658241153720"><a name="zh-cn_topic_0237088800_screen6658241153720"></a><a name="zh-cn_topic_0237088800_screen6658241153720"></a><strong id="zh-cn_topic_0237088800_b1266274123710"><a name="zh-cn_topic_0237088800_b1266274123710"></a><a name="zh-cn_topic_0237088800_b1266274123710"></a>gs_checkos -i B1</strong>
<strong id="zh-cn_topic_0237088800_b18837153613816"><a name="zh-cn_topic_0237088800_b18837153613816"></a><a name="zh-cn_topic_0237088800_b18837153613816"></a>vim /etc/sysctl.conf</strong></pre>
</td>
</tr>
<tr id="row396734852"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p1589682816380"><a name="zh-cn_topic_0237088800_p1589682816380"></a><a name="zh-cn_topic_0237088800_p1589682816380"></a>CheckTHP（检查THP服务）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p7896728193820"><a name="zh-cn_topic_0237088800_p7896728193820"></a><a name="zh-cn_topic_0237088800_p7896728193820"></a>THP服务未开启</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p1889712883811"><a name="zh-cn_topic_0237088800_p1889712883811"></a><a name="zh-cn_topic_0237088800_p1889712883811"></a>使用gs_checkos设置THP服务。</p>
<pre class="screen" id="zh-cn_topic_0237088800_screen0120925104013"><a name="zh-cn_topic_0237088800_screen0120925104013"></a><a name="zh-cn_topic_0237088800_screen0120925104013"></a><strong id="zh-cn_topic_0237088800_b15124825194015"><a name="zh-cn_topic_0237088800_b15124825194015"></a><a name="zh-cn_topic_0237088800_b15124825194015"></a>gs_checkos -i B6</strong></pre>
</td>
</tr>
<tr id="row1596618413517"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p9749173119408"><a name="zh-cn_topic_0237088800_p9749173119408"></a><a name="zh-cn_topic_0237088800_p9749173119408"></a>CheckTimeZone（检查时区）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p167491731114015"><a name="zh-cn_topic_0237088800_p167491731114015"></a><a name="zh-cn_topic_0237088800_p167491731114015"></a>时区不一致</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p157491631164019"><a name="zh-cn_topic_0237088800_p157491631164019"></a><a name="zh-cn_topic_0237088800_p157491631164019"></a>设置各节点为同一时区。</p>
<pre class="screen" id="zh-cn_topic_0237088800_screen916593919411"><a name="zh-cn_topic_0237088800_screen916593919411"></a><a name="zh-cn_topic_0237088800_screen916593919411"></a><strong id="zh-cn_topic_0237088800_b9170153914118"><a name="zh-cn_topic_0237088800_b9170153914118"></a><a name="zh-cn_topic_0237088800_b9170153914118"></a>cp /usr/share/zoneinfo/<em id="zh-cn_topic_0237088800_a196df0a7625542ceb268ba65152b106f"><a name="zh-cn_topic_0237088800_a196df0a7625542ceb268ba65152b106f"></a><a name="zh-cn_topic_0237088800_a196df0a7625542ceb268ba65152b106f"></a>$主时区/$次时区</em> /etc/localtime</strong></pre>
</td>
</tr>
<tr id="row396615420519"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p877113804418"><a name="zh-cn_topic_0237088800_p877113804418"></a><a name="zh-cn_topic_0237088800_p877113804418"></a>CheckCPU（检查CPU）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p1577188114417"><a name="zh-cn_topic_0237088800_p1577188114417"></a><a name="zh-cn_topic_0237088800_p1577188114417"></a>CPU占用过高或IO等待过高</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p177712086441"><a name="zh-cn_topic_0237088800_p177712086441"></a><a name="zh-cn_topic_0237088800_p177712086441"></a>进行CPU配置升级或磁盘性能升级。</p>
</td>
</tr>
<tr id="row13966043516"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p1748194910469"><a name="zh-cn_topic_0237088800_p1748194910469"></a><a name="zh-cn_topic_0237088800_p1748194910469"></a>CheckSshdService（检查SSHD服务）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p1048649184612"><a name="zh-cn_topic_0237088800_p1048649184612"></a><a name="zh-cn_topic_0237088800_p1048649184612"></a>未开启SSHD服务</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p24814914615"><a name="zh-cn_topic_0237088800_p24814914615"></a><a name="zh-cn_topic_0237088800_p24814914615"></a>启动SSHD服务并写入开机自启动文件。</p>
<pre class="screen" id="zh-cn_topic_0237088800_screen10798193611615"><a name="zh-cn_topic_0237088800_screen10798193611615"></a><a name="zh-cn_topic_0237088800_screen10798193611615"></a><strong id="zh-cn_topic_0237088800_b3683174182517"><a name="zh-cn_topic_0237088800_b3683174182517"></a><a name="zh-cn_topic_0237088800_b3683174182517"></a>service sshd start</strong>
<strong id="zh-cn_topic_0237088800_b768434192519"><a name="zh-cn_topic_0237088800_b768434192519"></a><a name="zh-cn_topic_0237088800_b768434192519"></a>echo "server sshd start" &gt;&gt; initFile</strong></pre>
</td>
</tr>
<tr id="row8966647514"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p8611131811717"><a name="zh-cn_topic_0237088800_p8611131811717"></a><a name="zh-cn_topic_0237088800_p8611131811717"></a>CheckSshdConfig（检查SSHD配置）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p261131814717"><a name="zh-cn_topic_0237088800_p261131814717"></a><a name="zh-cn_topic_0237088800_p261131814717"></a>SSHD服务配置错误</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p66116181873"><a name="zh-cn_topic_0237088800_p66116181873"></a><a name="zh-cn_topic_0237088800_p66116181873"></a>设置SSHD服务，</p>
<pre class="screen" id="zh-cn_topic_0237088800_screen07161551184019"><a name="zh-cn_topic_0237088800_screen07161551184019"></a><a name="zh-cn_topic_0237088800_screen07161551184019"></a><strong id="b889318112578"><a name="b889318112578"></a><a name="b889318112578"></a>PasswordAuthentication=no;</strong>
<strong id="b290541115720"><a name="b290541115720"></a><a name="b290541115720"></a>MaxStartups=1000;</strong>
<strong id="b119075111578"><a name="b119075111578"></a><a name="b119075111578"></a>UseDNS=yes;</strong>
<strong id="b7909131112579"><a name="b7909131112579"></a><a name="b7909131112579"></a>ClientAliveInterval=10800/ClientAliveInterval=0</strong></pre>
<p id="zh-cn_topic_0237088800_p109911155407"><a name="zh-cn_topic_0237088800_p109911155407"></a><a name="zh-cn_topic_0237088800_p109911155407"></a>并重启服务：</p>
<pre class="screen" id="zh-cn_topic_0237088800_screen5262166812"><a name="zh-cn_topic_0237088800_screen5262166812"></a><a name="zh-cn_topic_0237088800_screen5262166812"></a><strong id="zh-cn_topic_0237088800_b16208121182514"><a name="zh-cn_topic_0237088800_b16208121182514"></a><a name="zh-cn_topic_0237088800_b16208121182514"></a>server sshd start</strong></pre>
</td>
</tr>
<tr id="row1696511413517"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p1020212171913"><a name="zh-cn_topic_0237088800_p1020212171913"></a><a name="zh-cn_topic_0237088800_p1020212171913"></a>CheckCrondService（检查Crond服务）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p102023178910"><a name="zh-cn_topic_0237088800_p102023178910"></a><a name="zh-cn_topic_0237088800_p102023178910"></a>Crond服务未启动</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p764625919914"><a name="zh-cn_topic_0237088800_p764625919914"></a><a name="zh-cn_topic_0237088800_p764625919914"></a>安装Crond服务并启用。</p>
</td>
</tr>
<tr id="row19651419518"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p5990192511132"><a name="zh-cn_topic_0237088800_p5990192511132"></a><a name="zh-cn_topic_0237088800_p5990192511132"></a>CheckStack（检查堆栈大小）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p1899019257131"><a name="zh-cn_topic_0237088800_p1899019257131"></a><a name="zh-cn_topic_0237088800_p1899019257131"></a>堆栈大小小于3072</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p16990192510139"><a name="zh-cn_topic_0237088800_p16990192510139"></a><a name="zh-cn_topic_0237088800_p16990192510139"></a>使用gs_checkos设置为3072并重启堆栈值过小进程。</p>
<pre class="screen" id="zh-cn_topic_0237088800_screen724123081415"><a name="zh-cn_topic_0237088800_screen724123081415"></a><a name="zh-cn_topic_0237088800_screen724123081415"></a><strong id="zh-cn_topic_0237088800_b1724523061413"><a name="zh-cn_topic_0237088800_b1724523061413"></a><a name="zh-cn_topic_0237088800_b1724523061413"></a>gs_checkos -i B2</strong></pre>
</td>
</tr>
<tr id="row185362291658"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p10417338181711"><a name="zh-cn_topic_0237088800_p10417338181711"></a><a name="zh-cn_topic_0237088800_p10417338181711"></a>CheckSysPortRange（检查系统端口设置）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p164175380179"><a name="zh-cn_topic_0237088800_p164175380179"></a><a name="zh-cn_topic_0237088800_p164175380179"></a>系统ip端口不在预期范围内或openGauss端口在系统ip端口内</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p1041723851717"><a name="zh-cn_topic_0237088800_p1041723851717"></a><a name="zh-cn_topic_0237088800_p1041723851717"></a>设置系统ip端口范围参数到26000-65535之中；设置openGauss端口在系统ip端口范围外。</p>
<pre class="screen" id="zh-cn_topic_0237088800_screen687583717203"><a name="zh-cn_topic_0237088800_screen687583717203"></a><a name="zh-cn_topic_0237088800_screen687583717203"></a><strong id="zh-cn_topic_0237088800_b38842374205"><a name="zh-cn_topic_0237088800_b38842374205"></a><a name="zh-cn_topic_0237088800_b38842374205"></a>vim /etc/sysctl.conf</strong></pre>
</td>
</tr>
<tr id="row18536122910516"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p79451553112013"><a name="zh-cn_topic_0237088800_p79451553112013"></a><a name="zh-cn_topic_0237088800_p79451553112013"></a>CheckMemInfo（检查内存信息）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p19945153142017"><a name="zh-cn_topic_0237088800_p19945153142017"></a><a name="zh-cn_topic_0237088800_p19945153142017"></a>各节点内存大小不一致</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p18945105320202"><a name="zh-cn_topic_0237088800_p18945105320202"></a><a name="zh-cn_topic_0237088800_p18945105320202"></a>使用相同规格的物理内存。</p>
</td>
</tr>
<tr id="row19535192913517"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p19243526122113"><a name="zh-cn_topic_0237088800_p19243526122113"></a><a name="zh-cn_topic_0237088800_p19243526122113"></a>CheckHyperThread（检查超线程）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p192432266214"><a name="zh-cn_topic_0237088800_p192432266214"></a><a name="zh-cn_topic_0237088800_p192432266214"></a>未开启CPU超线程</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p924322615213"><a name="zh-cn_topic_0237088800_p924322615213"></a><a name="zh-cn_topic_0237088800_p924322615213"></a>开启CPU超线程。</p>
</td>
</tr>
<tr id="row1953522910513"><td class="cellrowborder" valign="top" width="20.59%" headers="mcps1.2.4.1.1 "><p id="zh-cn_topic_0237088800_p171341847202114"><a name="zh-cn_topic_0237088800_p171341847202114"></a><a name="zh-cn_topic_0237088800_p171341847202114"></a>CheckTableSpace（检查表空间）</p>
</td>
<td class="cellrowborder" valign="top" width="22.21%" headers="mcps1.2.4.1.2 "><p id="zh-cn_topic_0237088800_p1413454782118"><a name="zh-cn_topic_0237088800_p1413454782118"></a><a name="zh-cn_topic_0237088800_p1413454782118"></a>表空间路径和openGauss路径存在嵌套或表空间路径相互存在嵌套</p>
</td>
<td class="cellrowborder" valign="top" width="57.199999999999996%" headers="mcps1.2.4.1.3 "><p id="zh-cn_topic_0237088800_p1013412471215"><a name="zh-cn_topic_0237088800_p1013412471215"></a><a name="zh-cn_topic_0237088800_p1013412471215"></a>将表空间数据迁移到路径合法的表空间中。</p>
</td>
</tr>
</tbody>
</table>





## 检查数据库性能

### 检查办法<a name="section543113244436"></a>

通过openGauss提供的性能统计工具gs\_checkperf可以对硬件性能进行检查。

**前提条件**

-   openGauss运行状态正常。
-   运行在数据库之上的业务运行正常。

**操作步骤**

1.  以操作系统用户omm登录数据库主节点。
2.  执行如下命令对openGauss数据库进行性能检查。

    ```
    gs_checkperf
    ```


具体的性能统计项目请参见《openGauss 工具参考》中“服务端工具 \> gs\_checkperf \> 性能检查项”。

**示例**

以简要格式在屏幕上显示性能统计结果。

```
gs_checkperf -i pmk -U omm
Cluster statistics information:
    Host CPU busy time ratio                     :    1.43       %
    MPPDB CPU time % in busy time                :    1.88       %
    Shared Buffer Hit ratio                      :    99.96      %
    In-memory sort ratio                         :    100.00     %
    Physical Reads                               :    4
    Physical Writes                              :    25
    DB size                                      :    70         MB
    Total Physical writes                        :    25
    Active SQL count                             :    2
    Session count                                :    3
```

### 异常处理<a name="section18189857124410"></a>

使用gs\_checkperf工具检查openGauss性能状态后，如果发现检查结果发现异常，可以根据以下内容进行修复。

**表 2**  检查openGauss级别性能状态

<a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ta9bb00b1705f47859f64e64e62901bb4"></a>
<table><thead align="left"><tr id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_r49fa7f9a647d47e78499e596fe8d51bd"><th class="cellrowborder" valign="top" width="25.840000000000003%" id="mcps1.2.3.1.1"><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a14856283d87843c28b066589d0ee3d06"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a14856283d87843c28b066589d0ee3d06"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a14856283d87843c28b066589d0ee3d06"></a>异常状态</p>
</th>
<th class="cellrowborder" valign="top" width="74.16%" id="mcps1.2.3.1.2"><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a6b9800600182467d9ea16a216948f16f"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a6b9800600182467d9ea16a216948f16f"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a6b9800600182467d9ea16a216948f16f"></a>处理方法</p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_re2f2450dcb5243f58ca3a595f65ee474"><td class="cellrowborder" valign="top" width="25.840000000000003%" headers="mcps1.2.3.1.1 "><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a6845b2c7059f4b4e959b20f359e429dc"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a6845b2c7059f4b4e959b20f359e429dc"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a6845b2c7059f4b4e959b20f359e429dc"></a>主机CPU占有率高</p>
</td>
<td class="cellrowborder" valign="top" width="74.16%" headers="mcps1.2.3.1.2 "><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a44e3fccf12b1497e8fed2c41c000d24b"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a44e3fccf12b1497e8fed2c41c000d24b"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a44e3fccf12b1497e8fed2c41c000d24b"></a>1、更换和增加高性能的CPU。</p>
<p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a54f57f8b36724157bb98fc8a47c593d1"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a54f57f8b36724157bb98fc8a47c593d1"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a54f57f8b36724157bb98fc8a47c593d1"></a>2、使用top命令查看系统哪些进程的CPU占有率高，然后使用kill命令关闭没有使用的进程。</p>
<pre class="screen" id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_s1ca2034738bd454a923e9cd80bc4bfec"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_s1ca2034738bd454a923e9cd80bc4bfec"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_s1ca2034738bd454a923e9cd80bc4bfec"></a><strong id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_zh-cn_topic_0058967569_b162710768588"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_zh-cn_topic_0058967569_b162710768588"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_zh-cn_topic_0058967569_b162710768588"></a>top</strong></pre>
</td>
</tr>
<tr id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_re14ed83118e94cd4878eeb0042af49a2"><td class="cellrowborder" valign="top" width="25.840000000000003%" headers="mcps1.2.3.1.1 "><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a47db6382f1b7470b968b344b08e96ea1"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a47db6382f1b7470b968b344b08e96ea1"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a47db6382f1b7470b968b344b08e96ea1"></a>openGauss CPU占有率高</p>
</td>
<td class="cellrowborder" valign="top" width="74.16%" headers="mcps1.2.3.1.2 "><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ac789ba867ff84b6dbcdd406e7fe1ae25"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ac789ba867ff84b6dbcdd406e7fe1ae25"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ac789ba867ff84b6dbcdd406e7fe1ae25"></a>1、更换和增加高性能的CPU。</p>
<p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a71f31331eb5041b6ac95f86f4928bb57"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a71f31331eb5041b6ac95f86f4928bb57"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a71f31331eb5041b6ac95f86f4928bb57"></a>2、使用top命令查看数据库哪些进程的CPU占有率高，然后使用kill命令关闭没有使用的进程。</p>
<pre class="screen" id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_sde83d7290b2740458cef9c863eb7bba5"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_sde83d7290b2740458cef9c863eb7bba5"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_sde83d7290b2740458cef9c863eb7bba5"></a><strong id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ad91743105fd6451dbfbd30834f2d5390"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ad91743105fd6451dbfbd30834f2d5390"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ad91743105fd6451dbfbd30834f2d5390"></a>top</strong></pre>
<p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a7f471e4d60124c1585979ab7c5220cc5"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a7f471e4d60124c1585979ab7c5220cc5"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a7f471e4d60124c1585979ab7c5220cc5"></a>3、使用gs_expand工具扩容，增加新的主机均衡CPU占有率。</p>
</td>
</tr>
<tr id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_r8e114fc900a04dcab46feb1ec0cb4178"><td class="cellrowborder" valign="top" width="25.840000000000003%" headers="mcps1.2.3.1.1 "><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a308558a7e6cf43daa6aa01c22c7d198d"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a308558a7e6cf43daa6aa01c22c7d198d"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a308558a7e6cf43daa6aa01c22c7d198d"></a>共享内存命中率低</p>
</td>
<td class="cellrowborder" valign="top" width="74.16%" headers="mcps1.2.3.1.2 "><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a1852df9339af4a8284d9c080e0cfeb03"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a1852df9339af4a8284d9c080e0cfeb03"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a1852df9339af4a8284d9c080e0cfeb03"></a>1、扩大内存。</p>
<p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a85c00d263afa436fa91aa7adceeb1fda"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a85c00d263afa436fa91aa7adceeb1fda"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a85c00d263afa436fa91aa7adceeb1fda"></a>2、使用如下命令查看操作系统配置文件/etc/sysctl.conf，调大共享内存kernel.shmmax值。</p>
<pre class="screen" id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_s2ddc0f5946584adb9c117093afe0ce0d"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_s2ddc0f5946584adb9c117093afe0ce0d"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_s2ddc0f5946584adb9c117093afe0ce0d"></a><strong id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_aa5930b62532e4aaf96a0e1f4e22001fd"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_aa5930b62532e4aaf96a0e1f4e22001fd"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_aa5930b62532e4aaf96a0e1f4e22001fd"></a>vim /etc/sysctl.conf</strong></pre>
</td>
</tr>
<tr id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_rb696a9cd1e274702b0cf2f94b187656c"><td class="cellrowborder" valign="top" width="25.840000000000003%" headers="mcps1.2.3.1.1 "><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a3f5bf8f8e1f54be4bb75dc3463a26e84"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a3f5bf8f8e1f54be4bb75dc3463a26e84"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a3f5bf8f8e1f54be4bb75dc3463a26e84"></a>内存中排序比率低</p>
</td>
<td class="cellrowborder" valign="top" width="74.16%" headers="mcps1.2.3.1.2 "><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a5d1142ae67e94e4994bf9ec3714b676c"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a5d1142ae67e94e4994bf9ec3714b676c"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a5d1142ae67e94e4994bf9ec3714b676c"></a>扩大内存。</p>
</td>
</tr>
<tr id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_r33f8c42af67944649f3721213a5d92a3"><td class="cellrowborder" valign="top" width="25.840000000000003%" headers="mcps1.2.3.1.1 "><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_zh-cn_topic_0058967569_p118437201120"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_zh-cn_topic_0058967569_p118437201120"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_zh-cn_topic_0058967569_p118437201120"></a>I/O、磁盘使用率高</p>
</td>
<td class="cellrowborder" valign="top" width="74.16%" headers="mcps1.2.3.1.2 "><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_zh-cn_topic_0058967569_p198172641120"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_zh-cn_topic_0058967569_p198172641120"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_zh-cn_topic_0058967569_p198172641120"></a>1、更换高性能的磁盘。</p>
<p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a871444be7e48432fac84f36a3917f396"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a871444be7e48432fac84f36a3917f396"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a871444be7e48432fac84f36a3917f396"></a>2、调整数据布局，尽量将I/O请求较合理的分配到所有物理磁盘中。</p>
<p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ad2af8b58ca4c4d7b9f8ed529cc657373"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ad2af8b58ca4c4d7b9f8ed529cc657373"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ad2af8b58ca4c4d7b9f8ed529cc657373"></a>3、全库进行VACUUM FULL操作。</p>
<pre class="screen" id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_s950ede86b0fc4b8d820ddf111a4af7ba"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_s950ede86b0fc4b8d820ddf111a4af7ba"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_s950ede86b0fc4b8d820ddf111a4af7ba"></a><strong id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a591b2fecdd80432c86d67004a37cde53"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a591b2fecdd80432c86d67004a37cde53"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a591b2fecdd80432c86d67004a37cde53"></a>vacuum full;</strong></pre>
<p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_zh-cn_topic_0058967569_p585332361508"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_zh-cn_topic_0058967569_p585332361508"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_zh-cn_topic_0058967569_p585332361508"></a>4、进行磁盘整理，参考上面执行全库vacuum full或针对性做单表vacuum/vacuum full操作。</p>
<p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ad9c1986c98924c0a9d72816f494d1be5"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ad9c1986c98924c0a9d72816f494d1be5"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ad9c1986c98924c0a9d72816f494d1be5"></a>5、降低并发数。</p>
</td>
</tr>
<tr id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_rc4d4497849014f999b56ca6feb688762"><td class="cellrowborder" valign="top" width="25.840000000000003%" headers="mcps1.2.3.1.1 "><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a6e75cd66b1094cec8381d0212ec3c401"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a6e75cd66b1094cec8381d0212ec3c401"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a6e75cd66b1094cec8381d0212ec3c401"></a>事务统计</p>
</td>
<td class="cellrowborder" valign="top" width="74.16%" headers="mcps1.2.3.1.2 "><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a3b307c31e29e4090b9ea53082fb69215"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a3b307c31e29e4090b9ea53082fb69215"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a3b307c31e29e4090b9ea53082fb69215"></a>查询pg_stat_activity系统表，将不必要的连接断开。（登录数据库后查询：openGauss=# \d+ pg_stat_activity;）</p>
</td>
</tr>
</tbody>
</table>
**表 3**  检查节点级别性能状态

<a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_t1b8a1ca94cde400ba44ab4ce0eb81bd6"></a>
<table><thead align="left"><tr id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_r0bdfef97fc9e470c830a138b33f00f40"><th class="cellrowborder" valign="top" width="25.669999999999998%" id="mcps1.2.3.1.1"><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a53a50b5e5e6b4e11a3273052480f3dd2"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a53a50b5e5e6b4e11a3273052480f3dd2"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a53a50b5e5e6b4e11a3273052480f3dd2"></a>异常状态</p>
</th>
<th class="cellrowborder" valign="top" width="74.33%" id="mcps1.2.3.1.2"><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a4a72f839428e4c259dda47c54e4fa4e1"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a4a72f839428e4c259dda47c54e4fa4e1"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a4a72f839428e4c259dda47c54e4fa4e1"></a>处理方法</p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_r4c4f805b81e74311b4222bcb8ac8b28b"><td class="cellrowborder" valign="top" width="25.669999999999998%" headers="mcps1.2.3.1.1 "><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_zh-cn_topic_0058967569_p576708711746"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_zh-cn_topic_0058967569_p576708711746"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_zh-cn_topic_0058967569_p576708711746"></a>CPU占有率高</p>
</td>
<td class="cellrowborder" valign="top" width="74.33%" headers="mcps1.2.3.1.2 "><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ab6721e4ef4184d2cadb0d848f7afb6e1"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ab6721e4ef4184d2cadb0d848f7afb6e1"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ab6721e4ef4184d2cadb0d848f7afb6e1"></a>1、更换和增加高性能的CPU。</p>
<p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a2075fff6c7974952b4b21a4f9137a663"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a2075fff6c7974952b4b21a4f9137a663"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a2075fff6c7974952b4b21a4f9137a663"></a>2、使用top命令查看系统哪些进程的CPU占有率高，然后使用kill命令关闭没有使用的进程。</p>
<pre class="screen" id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_sd4b03c40edc44fe8832ad2260f90ea5b"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_sd4b03c40edc44fe8832ad2260f90ea5b"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_sd4b03c40edc44fe8832ad2260f90ea5b"></a><strong id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ae5250bfa530948cf91760fae4fd25eba"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ae5250bfa530948cf91760fae4fd25eba"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ae5250bfa530948cf91760fae4fd25eba"></a>top</strong></pre>
</td>
</tr>
<tr id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_rf18fcfbb99664d8888093a6de5ef3199"><td class="cellrowborder" valign="top" width="25.669999999999998%" headers="mcps1.2.3.1.1 "><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ae5d10ca1786a4bbbb8b9952bbd7e4f98"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ae5d10ca1786a4bbbb8b9952bbd7e4f98"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ae5d10ca1786a4bbbb8b9952bbd7e4f98"></a>内存使用率过高情况</p>
</td>
<td class="cellrowborder" valign="top" width="74.33%" headers="mcps1.2.3.1.2 "><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_abc08d798101a442b921534d4a3b7e3f2"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_abc08d798101a442b921534d4a3b7e3f2"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_abc08d798101a442b921534d4a3b7e3f2"></a>扩大或清理内存。</p>
</td>
</tr>
<tr id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_r8c887a14e01c44ff9272d6236e49cdfd"><td class="cellrowborder" valign="top" width="25.669999999999998%" headers="mcps1.2.3.1.1 "><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ad3374332489c4f0e8c1103c80f2e8c92"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ad3374332489c4f0e8c1103c80f2e8c92"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ad3374332489c4f0e8c1103c80f2e8c92"></a>I/O使用率过高情况</p>
</td>
<td class="cellrowborder" valign="top" width="74.33%" headers="mcps1.2.3.1.2 "><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a79a892beec7b4ed3b3762c387a3f6ef3"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a79a892beec7b4ed3b3762c387a3f6ef3"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a79a892beec7b4ed3b3762c387a3f6ef3"></a>1、更换高性能的磁盘。</p>
<p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_af8ecf84c5f5241e3bf872cede65af9de"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_af8ecf84c5f5241e3bf872cede65af9de"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_af8ecf84c5f5241e3bf872cede65af9de"></a>2、进行磁盘清理。</p>
<p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_zh-cn_topic_0058967569_p560803311746"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_zh-cn_topic_0058967569_p560803311746"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_zh-cn_topic_0058967569_p560803311746"></a>3、尽可能用内存的读写代替直接磁盘I/O，使频繁访问的文件或数据放入内存中进行操作处理。</p>
</td>
</tr>
</tbody>
</table>
**表 4**  会话/进程级别性能状态

<a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_t803713a284c74d5885e7fcb52813917b"></a>
<table><thead align="left"><tr id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_rbbc99ba73be6467dbdd58ba220a6d5cd"><th class="cellrowborder" valign="top" width="25.380000000000003%" id="mcps1.2.3.1.1"><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a4291e4ba9a014994b720a8742a08799d"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a4291e4ba9a014994b720a8742a08799d"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a4291e4ba9a014994b720a8742a08799d"></a>异常状态</p>
</th>
<th class="cellrowborder" valign="top" width="74.62%" id="mcps1.2.3.1.2"><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ab5395d8f4a594480bd79abbae9624adb"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ab5395d8f4a594480bd79abbae9624adb"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_ab5395d8f4a594480bd79abbae9624adb"></a>处理方法</p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_r1a46a92c987b4f00a908004d21d52f41"><td class="cellrowborder" valign="top" width="25.380000000000003%" headers="mcps1.2.3.1.1 "><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a4bea0e38f0cc47c0bf5f651b37250c06"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a4bea0e38f0cc47c0bf5f651b37250c06"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a4bea0e38f0cc47c0bf5f651b37250c06"></a>CPU、内存、I/O使用率过高情况</p>
</td>
<td class="cellrowborder" valign="top" width="74.62%" headers="mcps1.2.3.1.2 "><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_aa99bdba844bb4631acb972fa02bc6b6e"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_aa99bdba844bb4631acb972fa02bc6b6e"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_aa99bdba844bb4631acb972fa02bc6b6e"></a>查看哪个进程占用CPU/内存高或I/O使用率高，若是无用的进程，则kill掉，否则排查具体原因。例如SQL执行占用内存大，查看是否SQL语句需要优化。</p>
</td>
</tr>
</tbody>
</table>

**表 5**  SSD性能状态

<a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_t28cda86dba7a49c899f17955edef6d58"></a>
<table><thead align="left"><tr id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_r9c07b2295ced4359914301ac747cfc29"><th class="cellrowborder" valign="top" width="25.19%" id="mcps1.2.3.1.1"><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_aa1399d9355974ff7a022d1154f5f8fd6"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_aa1399d9355974ff7a022d1154f5f8fd6"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_aa1399d9355974ff7a022d1154f5f8fd6"></a>异常状态</p>
</th>
<th class="cellrowborder" valign="top" width="74.81%" id="mcps1.2.3.1.2"><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_aae6858632024460bbcad3f92c1a27a78"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_aae6858632024460bbcad3f92c1a27a78"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_aae6858632024460bbcad3f92c1a27a78"></a>处理方法</p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_r54645227d0d54a55958134712e92de36"><td class="cellrowborder" valign="top" width="25.19%" headers="mcps1.2.3.1.1 "><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_abda6cf2903e74f6b803f5b2953f56dfb"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_abda6cf2903e74f6b803f5b2953f56dfb"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_abda6cf2903e74f6b803f5b2953f56dfb"></a>SSD读写性能故障</p>
</td>
<td class="cellrowborder" valign="top" width="74.81%" headers="mcps1.2.3.1.2 "><p id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a30a4d99dd52146e8912775714734140e"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a30a4d99dd52146e8912775714734140e"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_a30a4d99dd52146e8912775714734140e"></a>使用以下命令查看SSD是否有故障，排查具体故障原因。</p>
<pre class="screen" id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_sf43af852b9f44a78811cf4896729ff0a"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_sf43af852b9f44a78811cf4896729ff0a"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_sf43af852b9f44a78811cf4896729ff0a"></a><strong id="zh-cn_topic_0237088803_zh-cn_topic_0059777708_zh-cn_topic_0058967569_b36437085836"><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_zh-cn_topic_0058967569_b36437085836"></a><a name="zh-cn_topic_0237088803_zh-cn_topic_0059777708_zh-cn_topic_0058967569_b36437085836"></a>gs_checkperf -i SSD -U</strong> <span id="zh-cn_topic_0237088803_text461533435513"><a name="zh-cn_topic_0237088803_text461533435513"></a><a name="zh-cn_topic_0237088803_text461533435513"></a>omm</span></pre>
</td>
</tr>
</tbody>
</table>

## 检查和清理日志

日志是检查系统运行及故障定位的关键手段。建议按月度例行查看操作系统日志及数据库的运行日志。同时，随着时间的推移，日志的增加会占用较多的磁盘空间。建议按月度清理数据库的运行日志。

### 检查操作系统日志<a name="section1891764310611"></a>

建议按月检查操作系统日志，排除操作系统运行异常隐患。

执行如下命令查看操作系统日志文件。

```
vim /var/log/messages
```

关注其中近一个月出现的kernel、error、fatal等字样，根据系统报警信息进行处理。

### 检查openGauss运行日志<a name="section111401118810"></a>

数据库运行时，某些操作在执行过程中可能会出现错误，数据库依然能够运行。但是此时数据库中的数据可能已经发生不一致的情况。建议按月检查openGauss运行日志，及时发现隐患。

**前提条件**

-   收集日志的主机网络通畅且未宕机，数据库安装用户互信正常。
-   日志收集工具依赖操作系统工具如gstack，如果未安装该工具，则提示错误后，跳过该收集项。

**操作步骤**

1.  以操作系统用户omm登录数据库主节点。
2.  <a name="zh-cn_topic_0237088806_zh-cn_topic_0059778412_l87490fc259434bc6ac7800ec9881a6ab"></a>执行如下命令收集数据库日志。

    ```
    gs_collector --begin-time="20160616 01:01" --end-time="20160616 23:59"
    ```

    20160616 01:01为日志的开始时间，20160616 23:59为日志的结束时间。

3.  根据[2](#zh-cn_topic_0237088806_zh-cn_topic_0059778412_l87490fc259434bc6ac7800ec9881a6ab)的界面输出提示，进入相应的日志收集目录，解压收集的日志，并检查数据库日志。

    以下以日志收集路径“/opt/gaussdb/tmp/gaussdba\_mppdb/collector\_20160726\_105158.tar.gz”为例进行操作。

    ```
    tar -xvzf /opt/gaussdb/tmp/gaussdba_mppdb/collector_20160726_105158.tar.gz 
    cd /opt/gaussdb/tmp/gaussdba_mppdb/collector_20160726_105158
    ```


**示例**

-   以--begin-time与--end-time为参数执行gs\_collector命令。

    ```
    gs_collector --begin-time="20160616 01:01" --end-time="20160616 23:59"
    ```

    当显示类似如下信息表示日志已经归档。

    ```
    Successfully collected  files 
    All results are stored in /tmp/gaussdba_mppdb/collector_20160616_175615.tar.gz.
    ```

-   以--begin-time、--end-time与-h为参数执行gs\_collector命令。

    ```
    gs_collector --begin-time="20160616 01:01" --end-time="20160616 23:59" -h plat2
    ```

    当显示类似如下信息表示日志已经归档。

    ```
    Successfully collected  files
    All results are stored in /tmp/gaussdba_mppdb/collector_20160616_190225.tar.gz.
    ```

-   以--begin-time、--end-time与-f为参数执行gs\_collector命令。

    ```
    gs_collector --begin-time="20160616 01:01" --end-time="20160616 23:59" -f /opt/software/gaussdb/output
    ```

    当显示类似如下信息表示日志已经归档。

    ```
    Successfully collected  files
    All results are stored in /opt/software/gaussdb/output/collector_20160616_190511.tar.gz.
    ```

-   以--begin-time、--end-time与--keyword为参数执行gs\_collector命令。

    ```
    gs_collector --begin-time="20160616 01:01" --end-time="20160616 23:59" --keyword="os"
    ```

    当显示类似如下信息表示日志已经归档。

    ```
    Successfully collected files.
    All results are stored in /tmp/gaussdba_mppdb/collector_20160616_190836.tar.gz.
    ```

-   以--begin-time、--end-time与-o为参数执行gs\_collector命令。

    ```
    gs_collector --begin-time="20160616 01:01" --end-time="20160616 23:59" -o /opt/software/gaussdb/output
    ```

    当显示类似如下信息表示日志已经归档。

    ```
    Successfully collected files.
    All results are stored in /opt/software/gaussdb/output/collector_20160726_113711.tar.gz.
    ```

-   以--begin-time、--end-time与-l为参数（文件名必须以.log为后缀）执行gs\_collector命令。

    ```
    gs_collector --begin-time="20160616 01:01" --end-time="20160616 23:59" -l /opt/software/gaussdb/logfile.log
    ```

    当显示类似如下信息表示日志已经归档。

    ```
    Successfully collected files.
    All results are stored in /opt/software/gaussdb/output/collector_20160726_113711.tar.gz.
    ```


### 清理运行日志<a name="section62197109131"></a>

数据库运行过程中会产生大量运行日志，占用大量的磁盘空间，建议清理过期日志文件，只保留一个月的日志。

**操作步骤**

1.  以操作系统用户omm登录数据库主节点。
2.  清理日志。

    a. 将超过1个月的日志备份到其他磁盘。

    b. 进入日志存放目录。

    ```
    cd $GAUSSLOG
    ```

    c. 进入相应的子目录，使用如下方式删除1个月之前产生的日志。

    ```
    rm 日志名称
    ```

    日志文件的命名格式为“postgresql-年-月-日\_HHMMSS”。



## 检查时间一致性

数据库事务一致性通过逻辑时钟保证，与操作系统时间无关，但是系统时间不一致会导致诸多潜在问题，主要是后台运维和监控功能异常，因此在月度检查时建议检查各个节点的时间一致性。

### 操作步骤<a name="zh-cn_topic_0237088808_zh-cn_topic_0059777703_s7110d1c3f93a4bdea6f206e6709de04f"></a>

1.  以操作系统用户omm登录数据库主节点。
2.  创建记录openGauss各节点的配置文件（_mpphosts文件目录_用户可随意指定，建议放在/tmp下）。

    ```
    vim /tmp/mpphosts
    ```

    增加各节点的主机名称。

    ```
    plat1
    plat2
    plat3
    ```

3.  保存配置文件。

    ```
    :wq!
    ```

4.  执行如下命令，输出各节点上的时间到“/tmp/sys\_ctl-os1.log”文件中。

    ```
    for ihost in `cat /tmp/mpphosts`; do ssh -n -q $ihost "hostname;date"; done > /tmp/sys_ctl-os1.log
    ```

5.  根据输出确认各个节点的时间一致性，节点之间时间差异不能超过30秒。

    ```
    cat /tmp/sys_ctl-os1.log
    plat1
    Thu Feb  9 16:46:38 CST 2017
    plat2
    Thu Feb  9 16:46:49 CST 2017
    plat3
    Thu Feb  9 16:46:14 CST 2017
    ```


## 检查应用连接数

如果应用程序与数据库的连接数超过最大值，则新的连接无法建立。建议每天检查连接数，及时释放空闲的连接或者增加最大连接数。

### 操作步骤<a name="zh-cn_topic_0237088809_zh-cn_topic_0059777858_s8aaa4c4f54fe4b97b5bf3a874789aad6"></a>

1.  以操作系统用户omm登录数据库主节点。
2.  使用如下命令连接数据库。

    ```
    gsql -d postgres -p 8000
    ```

    postgres为需要连接的数据库名称，8000为数据库主节点的端口号。

    连接成功后，系统显示类似如下信息：

    ```
    gsql ((openGauss 1.0 build 290d125f) compiled at 2020-05-08 02:59:43 commit 2143 last mr 131
    Non-SSL connection (SSL connection is recommended when requiring high-security)
    Type "help" for help.
    
    openGauss=# 
    ```

3.  执行如下SQL语句查看连接数。

    ```
    openGauss=# SELECT count(*) FROM (SELECT pg_stat_get_backend_idset() AS backendid) AS s;
    ```

    显示类似如下的信息，其中2表示当前有两个应用连接到数据库。

    ```
    count
    -------
         2
    (1 row)
    ```

4.  查看现有最大连接数。

    ```
    openGauss=# SHOW max_connections;
    ```

    显示信息如下，其中200为现在的最大连接数。

    ```
     max_connections 
    -----------------
     200
    (1 row)
    ```


### 异常处理<a name="zh-cn_topic_0237088809_zh-cn_topic_0059777858_sd21b84e4719d479daa8c2a0a7bef2589"></a>

如果显示的连接数接近数据库的最大连接数max\_connections，则需要考虑清理现有连接数或者增加新的连接数。

1.  执行如下SQL语句，查看state字段等于idle，且state\_change字段长时间没有更新过的连接信息。

    ```
    openGauss=# SELECT * FROM pg_stat_activity where state='idle' order by state_change;
    ```

    显示类似如下的信息：

    ```
     datid | datname  |       pid       | usesysid | usename  | application_name |  client_addr  
     | client_hostname | client_port |         backend_start         | xact_start |          quer
    y_start          |         state_change          | waiting | enqueue | state | resource_pool 
    |                    query                     
    -------+----------+-----------------+----------+----------+------------------+---------------
    -+-----------------+-------------+-------------------------------+------------+--------------
    -----------------+-------------------------------+---------+---------+-------+---------------
    +----------------------------------------------
     13626 | postgres | 140390162233104 |       10 | gaussdba |                  |               
     |                 |          -1 | 2016-07-15 14:08:59.474118+08 |            | 2016-07-15 14
    :09:04.496769+08 | 2016-07-15 14:09:04.496975+08 | f       |         | idle  | default_pool  
    | select count(group_name) from pgxc_group;
     13626 | postgres | 140390132872976 |       10 | gaussdba | cn_5002          | 10.180.123.163
     |                 |       48614 | 2016-07-15 14:11:16.014871+08 |            | 2016-07-15 14
    :21:17.346045+08 | 2016-07-15 14:21:17.346095+08 | f       |         | idle  | default_pool  
    | SET SESSION AUTHORIZATION DEFAULT;RESET ALL;
    (2 rows)
    ```

2.  释放空闲的连接数。

    查看每个连接，并与此连接的使用者确认是否可以断开连接，或执行如下SQL语句释放连接。其中，pid为上一步查询中空闲连接所对应的pid字段值。

    ```
    openGauss=# SELECT pg_terminate_backend(140390132872976);
    ```

    显示类似如下的信息：

    ```
    openGauss=# SELECT pg_terminate_backend(140390132872976);
     pg_terminate_backend 
    ----------------------
     t
    (1 row)
    ```

    如果没有可释放的连接，请执行下一步。

3.  增加最大连接数。

    ```
    gs_guc set -D /gaussdb/data/dbnode -c "max_connections= 800"
    ```

    其中800为新修改的连接数。

4.  重启数据库服务使新的设置生效。

    >![](public_sys-resources/icon-note.gif) **说明：** 
    >重启openGauss操作会导致用户执行操作中断，请在操作之前规划好合适的执行窗口。

    ```
    gs_om -t stop && gs_om -t start
    ```


## 例行维护表

为了保证数据库的有效运行，数据库必须在插入/删除操作后，基于客户场景，定期做VACUUM FULL和ANALYZE，更新统计信息，以便获得更优的性能。

### 相关概念<a name="zh-cn_topic_0237088810_zh-cn_topic_0111591987_zh-cn_topic_0085032190_zh-cn_topic_0059779302_section1275717610563"></a>

使用VACUUM、VACUUM FULL和ANALYZE命令定期对每个表进行维护，主要有以下原因：

-   VACUUM FULL可回收已更新或已删除的数据所占据的磁盘空间，同时将小数据文件合并。
-   VACUUM对每个表维护了一个可视化映射来跟踪包含对别的活动事务可见的数组的页。一个普通的索引扫描首先通过可视化映射来获取对应的数组，来检查是否对当前事务可见。若无法获取，再通过堆数组抓取的方式来检查。因此更新表的可视化映射，可加速唯一索引扫描。
-   VACUUM可避免执行的事务数超过数据库阈值时，事务ID重叠造成的原有数据丢失。
-   ANALYZE可收集与数据库中表内容相关的统计信息。统计结果存储在系统表PG\_STATISTIC中。查询优化器会使用这些统计数据，生成最有效的执行计划。

### 操作步骤<a name="zh-cn_topic_0237088810_zh-cn_topic_0111591987_zh-cn_topic_0085032190_zh-cn_topic_0059779302_section97581768562"></a>

1.  使用VACUUM或VACUUM FULL命令，进行磁盘空间回收。
    -   **VACUUM**：

        对表执行VACUUM操作

        ```
        openGauss=# VACUUM customer;
        ```

        ```
        VACUUM
        ```

        可以与数据库操作命令并行运行。（执行期间，可正常使用的语句：SELECT、INSERT、UPDATE和DELETE。不可正常使用的语句：ALTER TABLE）。

        对表分区执行VACUUM操作

        ```
        openGauss=# VACUUM customer_par PARTITION ( P1 );
        ```

        ```
        VACUUM
        ```

    -   **VACUUM FULL**：

        ```
        openGauss=# VACUUM FULL customer;
        ```

        ```
        VACUUM
        ```

        需要向正在执行的表增加排他锁，且需要停止其他所有数据库操作。

2.  使用ANALYZE语句更新统计信息。

    ```
    openGauss=# ANALYZE customer;
    ```

    ```
    ANALYZE
    ```

    使用ANALYZE VERBOSE语句更新统计信息，并输出表的相关信息。

    ```
    openGauss=# ANALYZE VERBOSE customer;
    ```

    ```
    ANALYZE
    ```

    也可以同时执行VACUUM ANALYZE命令进行查询优化。

    ```
    openGauss=# VACUUM ANALYZE customer;
    ```

    ```
    VACUUM
    ```

    >![](public_sys-resources/icon-note.gif) **说明：** 
    >VACUUM和ANALYZE会导致I/O流量的大幅增加，这可能会影响其他活动会话的性能。因此，建议通过“vacuum\_cost\_delay”参数设置《开发者指南》中“GUC参数说明 \> 资源消耗 \> 基于开销的清理延迟”。

3.  删除表。

    ```
    openGauss=# DROP TABLE customer;
    openGauss=# DROP TABLE customer_par;
    openGauss=# DROP TABLE part;
    ```

    当结果显示为如下信息，则表示删除成功。

    ```
    DROP TABLE
    ```


### 维护建议<a name="zh-cn_topic_0237088810_zh-cn_topic_0111591987_zh-cn_topic_0085032190_zh-cn_topic_0059779302_section976110616566"></a>

-   定期对部分大表做VACUUM FULL，在性能下降后为全库做VACUUM FULL，目前暂定每月做一次VACUUM FULL。
-   定期对系统表做VACUUM FULL，主要是PG\_ATTRIBUTE。
-   启用系统自动清理线程（AUTOVACUUM）自动执行VACUUM和ANALYZE，回收被标识为删除状态的记录空间，并更新表的统计数据。

## 例行重建索引

### 背景信息<a name="zh-cn_topic_0237088811_zh-cn_topic_0059779198_sb20e9236c2ee4359bd71385a42b73ce8"></a>

数据库经过多次删除操作后，索引页面上的索引键将被删除，造成索引膨胀。例行重建索引，可有效的提高查询效率。

数据库支持的索引类型为B-tree索引，例行重建索引可有效的提高查询效率。

-   如果数据发生大量删除后，索引页面上的索引键将被删除，导致索引页面数量的减少，造成索引膨胀。重建索引可回收浪费的空间。
-   新建的索引中逻辑结构相邻的页面，通常在物理结构中也是相邻的，所以一个新建的索引比更新了多次的索引访问速度要快。

### 重建索引<a name="zh-cn_topic_0237088811_section1483310439110"></a>

重建索引有以下两种方式：

-   先运行DROP INDEX语句删除索引，再运行CREATE INDEX语句创建索引。

    在删除索引过程中，会在父表上增加一个短暂的排他锁，阻止相关读写操作。在创建索引过程中，会锁住写操作但是不会锁住读操作，此时读操作只能使用顺序扫描。

-   使用REINDEX语句重建索引。
    -   使用REINDEX TABLE语句重建索引，会在重建过程中增加排他锁，阻止相关读写操作。
    -   使用REINDEX INTERNAL TABLE语句重建desc表（包括列存表的cudesc表）的索引，会在重建过程中增加排他锁，阻止相关读写操作。


### 操作步骤<a name="zh-cn_topic_0237088811_zh-cn_topic_0059779198_s5066efbb8c0d462694edc169c57822b0"></a>

假定在导入表“areaS”上的“area\_id”字段上存在普通索引“areaS\_idx”。重建索引有以下两种方式：

-   先删除索引（DROP INDEX），再创建索引（CREATE INDEX）。
    1.  删除索引。

        ```
        openGauss=# DROP INDEX areaS_idx;
        ```
        当结果显示如下信息，则表示删除成功。
        ```
        DROP INDEX
        ```

    2.  创建索引。

        ```
        openGauss=# CREATE INDEX areaS_idx ON areaS (area_id);
        ```
        当结果显示如下信息，则表示创建成功。
        ```
        CREATE INDEX
        ```

-   使用REINDEX重建索引。
    -   使用REINDEX TABLE语句重建索引。

        ```
        openGauss=# REINDEX TABLE areaS;
        ```
        当结果显示如下信息，则表示重建成功。
        ```
        REINDEX
        ```

    -   使用REINDEX INTERNAL TABLE重建desc表（包括列存表的cudesc表）的索引。

        ```
        openGauss=# REINDEX INTERNAL TABLE areaS;
        ```
        当结果显示如下信息，则表示重建成功。
        ```
        REINDEX
        ```


>![](public_sys-resources/icon-note.gif) **说明：** 
>在重建索引前，用户可以通过临时增大maintenance\_work\_mem和psort\_work\_mem的取值来加快索引的重建。

## 导出并查看wdr诊断报告

生成快照数据需参数enable_wdr_snapshot=on，访问WDR快照数据需要sysadmin或monadmin权限，因此需要使用root账号或其他拥有权限的账号来生成WDR诊断报告。

1. 执行如下命令新建报告文件。

   ```
   touch  /home/om/wdrTestNode.html
   ```

2. 连接系统库postgres。

   ```
   gsql -d postgres -p 端口号 -r
   ```

3. 选择snapshot.snapshot表中两个不同的snapshot，当这两个snapshot之间未发生服务重启，便可以使用这两个snapshot生成报告。

   ```
   openGauss=#  select * from snapshot.snapshot order by start_ts desc limit 10;
   ```

4. 执行如下命令，在本地生成HTML格式的WDR报告。

   1. 执行如下命令，设置报告格式。\\a: 不显示表行列符号， \\t:  不显示列名 ，\\o: 指定输出文件。

      ```
      openGauss=# \a \t \o {报告路径}
      ```

      示例：

      ```
      openGauss=# \a \t \o /home/omm/wdrTestNode.html
      ```

   2. 执行如下命令，生成HTML格式的WDR报告。

      ```
      openGauss=# select generate_wdr_report(begin_snap_id Oid, end_snap_id Oid, int report_type, int report_scope, int node_name );
      ```

      示例一，生成集群级别的报告：

      ```
      openGauss=# select generate_wdr_report(1, 2, 'all', 'cluster',null);
      ```

      示例二，生成某个节点的报告：

      ```
      openGauss=# select generate_wdr_report(1, 2, 'all', 'node', pgxc_node_str()::cstring);
      ```

      >![](public_sys-resources/icon-note.gif) **说明：** 
      >
      >- 当前openGauss的节点名固定是“dn\_6001”，也可直接代入。

      **表 1**  参数说明

      <a name="table612223716289"></a>

      <table><tbody><tr id="row20172113772815"><td class="cellrowborder" valign="top" width="16.04%"><p id="p1517210378288"><a name="p1517210378288"></a><a name="p1517210378288"></a>参数</p>
      </td>
      <td class="cellrowborder" valign="top" width="54.690000000000005%"><p id="p121721737132819"><a name="p121721737132819"></a><a name="p121721737132819"></a>说明</p>
      </td>
      <td class="cellrowborder" valign="top" width="29.270000000000003%"><p id="p117203752815"><a name="p117203752815"></a><a name="p117203752815"></a>取值范围</p>
      </td>
      </tr>
      <tr id="row1317233717281"><td class="cellrowborder" valign="top" width="16.04%"><p id="p141721337112810"><a name="p141721337112810"></a><a name="p141721337112810"></a>begin_snap_id</p>
      </td>
      <td class="cellrowborder" valign="top" width="54.690000000000005%"><p id="p1717263720289"><a name="p1717263720289"></a><a name="p1717263720289"></a>要查看的某段时间性能的开始的snapshot的id（表snapshot.snaoshot中的snapshot_id）</p>
      </td>
      <td class="cellrowborder" valign="top" width="29.270000000000003%"><p id="p141721337182813"><a name="p141721337182813"></a><a name="p141721337182813"></a>-</p>
      </td>
      </tr>
      <tr id="row9172113742815"><td class="cellrowborder" valign="top" width="16.04%"><p id="p51731637132811"><a name="p51731637132811"></a><a name="p51731637132811"></a>end_snap_id</p>
      </td>
      <td class="cellrowborder" valign="top" width="54.690000000000005%"><p id="p317313762815"><a name="p317313762815"></a><a name="p317313762815"></a>结束snapshot的id，默认end_snap_id大于begin_snap_id（表snapshot.snaoshot中的snapshot_id）</p>
      </td>
      <td class="cellrowborder" valign="top" width="29.270000000000003%"><p id="p12173113752819"><a name="p12173113752819"></a><a name="p12173113752819"></a>-</p>
      </td>
      </tr>
      <tr id="row1417312379281"><td class="cellrowborder" valign="top" width="16.04%"><p id="p2173153710282"><a name="p2173153710282"></a><a name="p2173153710282"></a>report_type</p>
      </td>
      <td class="cellrowborder" valign="top" width="54.690000000000005%"><p id="p71731375280"><a name="p71731375280"></a><a name="p71731375280"></a>指定生成report的类型。</p>
      </td>
      <td class="cellrowborder" valign="top" width="29.270000000000003%"><a name="ul4132243185013"></a><a name="ul4132243185013"></a><ul id="ul4132243185013"><li>summary</li><li>detail</li><li>all，即同时包含summary和detail。</li></ul>
      </td>
      </tr>
      <tr id="row13173937132817"><td class="cellrowborder" valign="top" width="16.04%"><p id="p19173203782815"><a name="p19173203782815"></a><a name="p19173203782815"></a>report_scope</p>
      </td>
      <td class="cellrowborder" valign="top" width="54.690000000000005%"><p id="p19173153712289"><a name="p19173153712289"></a><a name="p19173153712289"></a>指定生成report的范围。</p>
      </td>
      <td class="cellrowborder" valign="top" width="29.270000000000003%"><a name="ul18502133435114"></a><a name="ul18502133435114"></a><ul id="ul18502133435114"><li>cluster：集群</li><li>node：集群中某个节点。</li></ul>
      </td>
      </tr>
      <tr id="row13173113713282"><td class="cellrowborder" valign="top" width="16.04%"><p id="p17173173712819"><a name="p17173173712819"></a><a name="p17173173712819"></a>node_name</p>
      </td>
      <td class="cellrowborder" valign="top" width="54.690000000000005%"><a name="ul456943795214"></a><a name="ul456943795214"></a><ul id="ul456943795214"><li>在report_scope指定为single node时，需要把该参数指定为对应节点的名称。</li><li>在report_scope为cluster时，该值可以指定为省略或者为NULL。</li></ul>
      </td>
      <td class="cellrowborder" valign="top" width="29.270000000000003%"><p id="p617314374285"><a name="p617314374285"></a><a name="p617314374285"></a>-</p>
      </td>
      </tr>
      </tbody>
      </table>

5. 执行如下命令关闭输出选项及格式化输出命令。

   ```
   \o \a \t 
   ```

6. 在/home/om/下根据需要查看WDR报告内容。

   **表 2**  WDR报表主要内容

   <a name="table11575121514110"></a>

   <table><thead align="left"><tr id="row2575515415"><th class="cellrowborder" valign="top" width="27.27%" id="mcps1.2.3.1.1"><p id="p95769156115"><a name="p95769156115"></a><a name="p95769156115"></a>项目</p>
   </th>
   <th class="cellrowborder" valign="top" width="72.72999999999999%" id="mcps1.2.3.1.2"><p id="p11576141512113"><a name="p11576141512113"></a><a name="p11576141512113"></a>描述</p>
   </th>
   </tr>
   </thead>
   <tbody><tr id="row115761915713"><td class="cellrowborder" valign="top" width="27.27%" headers="mcps1.2.3.1.1 "><p id="p135718501312"><a name="p135718501312"></a><a name="p135718501312"></a>Database Stat（集群范围）</p>
   </td>
   <td class="cellrowborder" valign="top" width="72.72999999999999%" headers="mcps1.2.3.1.2 "><p id="p15576615117"><a name="p15576615117"></a><a name="p15576615117"></a>数据库维度性能统计信息：事务，读写，行活动，写冲突，死锁等。</p>
   </td>
   </tr>
   <tr id="row55761015114"><td class="cellrowborder" valign="top" width="27.27%" headers="mcps1.2.3.1.1 "><p id="p135731021"><a name="p135731021"></a><a name="p135731021"></a>Load Profile（集群范围）</p>
   </td>
   <td class="cellrowborder" valign="top" width="72.72999999999999%" headers="mcps1.2.3.1.2 "><p id="p357617151311"><a name="p357617151311"></a><a name="p357617151311"></a>集群维度的性能统计信息：CPU时间，DB时间，逻辑读/物理读，IO性能，登入登出，负载强度，负载性能表现等。</p>
   </td>
   </tr>
   <tr id="row18576141511115"><td class="cellrowborder" valign="top" width="27.27%" headers="mcps1.2.3.1.1 "><p id="p13524917629"><a name="p13524917629"></a><a name="p13524917629"></a>Instance Efficiency Percentages（集群/节点范围）</p>
   </td>
   <td class="cellrowborder" valign="top" width="72.72999999999999%" headers="mcps1.2.3.1.2 "><p id="p0576615218"><a name="p0576615218"></a><a name="p0576615218"></a>集群级或者节点缓冲命中率。</p>
   </td>
   </tr>
   <tr id="row131525233484"><td class="cellrowborder" valign="top" width="27.27%" headers="mcps1.2.3.1.1 "><p id="p1315310231485"><a name="p1315310231485"></a><a name="p1315310231485"></a>IO Profile（集群/节点范围）</p>
   </td>
   <td class="cellrowborder" valign="top" width="72.72999999999999%" headers="mcps1.2.3.1.2 "><p id="p14153323134813"><a name="p14153323134813"></a><a name="p14153323134813"></a>集群或者节点维度的IO的使用情况。</p>
   </td>
   </tr>
   <tr id="row115764151812"><td class="cellrowborder" valign="top" width="27.27%" headers="mcps1.2.3.1.1 "><p id="p177481629821"><a name="p177481629821"></a><a name="p177481629821"></a>Top 10 Events by Total Wait Time（节点范围）</p>
   </td>
   <td class="cellrowborder" valign="top" width="72.72999999999999%" headers="mcps1.2.3.1.2 "><p id="p1457618151110"><a name="p1457618151110"></a><a name="p1457618151110"></a>最消耗时间的事件。</p>
   </td>
   </tr>
   <tr id="row175761815718"><td class="cellrowborder" valign="top" width="27.27%" headers="mcps1.2.3.1.1 "><p id="p898917481218"><a name="p898917481218"></a><a name="p898917481218"></a>Wait Classes by Total Wait Time（节点范围）</p>
   </td>
   <td class="cellrowborder" valign="top" width="72.72999999999999%" headers="mcps1.2.3.1.2 "><p id="p85763154111"><a name="p85763154111"></a><a name="p85763154111"></a>最消耗时间的等待时间分类。</p>
   </td>
   </tr>
   <tr id="row55764151710"><td class="cellrowborder" valign="top" width="27.27%" headers="mcps1.2.3.1.1 "><p id="p6930825312"><a name="p6930825312"></a><a name="p6930825312"></a>Host CPU（节点范围）</p>
   </td>
   <td class="cellrowborder" valign="top" width="72.72999999999999%" headers="mcps1.2.3.1.2 "><p id="p1557621514116"><a name="p1557621514116"></a><a name="p1557621514116"></a>主机CPU消耗。</p>
   </td>
   </tr>
   <tr id="row857661514110"><td class="cellrowborder" valign="top" width="27.27%" headers="mcps1.2.3.1.1 "><p id="p7991716336"><a name="p7991716336"></a><a name="p7991716336"></a>Memory Statistics（节点范围）</p>
   </td>
   <td class="cellrowborder" valign="top" width="72.72999999999999%" headers="mcps1.2.3.1.2 "><p id="p19576101510115"><a name="p19576101510115"></a><a name="p19576101510115"></a>内核内存使用分布。</p>
   </td>
   </tr>
   <tr id="row1116032625515"><td class="cellrowborder" valign="top" width="27.27%" headers="mcps1.2.3.1.1 "><p id="p1316142615558"><a name="p1316142615558"></a><a name="p1316142615558"></a>Time Model（节点范围）</p>
   </td>
   <td class="cellrowborder" valign="top" width="72.72999999999999%" headers="mcps1.2.3.1.2 "><p id="p51611226135514"><a name="p51611226135514"></a><a name="p51611226135514"></a>节点范围的语句的时间分布信息。</p>
   </td>
   </tr>
   <tr id="row469714322313"><td class="cellrowborder" valign="top" width="27.27%" headers="mcps1.2.3.1.1 "><p id="p469710321319"><a name="p469710321319"></a><a name="p469710321319"></a>Wait Events（节点范围）</p>
   </td>
   <td class="cellrowborder" valign="top" width="72.72999999999999%" headers="mcps1.2.3.1.2 "><p id="p869818329318"><a name="p869818329318"></a><a name="p869818329318"></a>节点级别的等待事件的统计信息。</p>
   </td>
   </tr>
   <tr id="row32171134967"><td class="cellrowborder" valign="top" width="27.27%" headers="mcps1.2.3.1.1 "><p id="p4217934665"><a name="p4217934665"></a><a name="p4217934665"></a>Cache IO Stats (集群/节点范围)</p>
   </td>
   <td class="cellrowborder" valign="top" width="72.72999999999999%" headers="mcps1.2.3.1.2 "><p id="p42171134261"><a name="p42171134261"></a><a name="p42171134261"></a>用户的表、索引的IO的统计信息。</p>
   </td>
   </tr>
   <tr id="row13684036362"><td class="cellrowborder" valign="top" width="27.27%" headers="mcps1.2.3.1.1 "><p id="p136841836962"><a name="p136841836962"></a><a name="p136841836962"></a>Utility status （节点范围）</p>
   </td>
   <td class="cellrowborder" valign="top" width="72.72999999999999%" headers="mcps1.2.3.1.2 "><p id="p1168423613617"><a name="p1168423613617"></a><a name="p1168423613617"></a>复制槽和后台checkpoint的状态信息。</p>
   </td>
   </tr>
   <tr id="row185761150118"><td class="cellrowborder" valign="top" width="27.27%" headers="mcps1.2.3.1.1 "><p id="p12651331239"><a name="p12651331239"></a><a name="p12651331239"></a>Object stats（集群/节点范围）</p>
   </td>
   <td class="cellrowborder" valign="top" width="72.72999999999999%" headers="mcps1.2.3.1.2 "><p id="p1457691518114"><a name="p1457691518114"></a><a name="p1457691518114"></a>表、索引维度的性能统计信息。</p>
   </td>
   </tr>
   <tr id="row145762156112"><td class="cellrowborder" valign="top" width="27.27%" headers="mcps1.2.3.1.1 "><p id="p14537204613311"><a name="p14537204613311"></a><a name="p14537204613311"></a>Configuration settings（节点范围）</p>
   </td>
   <td class="cellrowborder" valign="top" width="72.72999999999999%" headers="mcps1.2.3.1.2 "><p id="p657615151715"><a name="p657615151715"></a><a name="p657615151715"></a>节点配置。</p>
   </td>
   </tr>
   <tr id="row4576111519111"><td class="cellrowborder" valign="top" width="27.27%" headers="mcps1.2.3.1.1 "><p id="p148180593320"><a name="p148180593320"></a><a name="p148180593320"></a>SQL Statistics（集群/节点范围）</p>
   </td>
   <td class="cellrowborder" valign="top" width="72.72999999999999%" headers="mcps1.2.3.1.2 "><p id="p75772015713"><a name="p75772015713"></a><a name="p75772015713"></a>SQL语句各个维度性能统计：端到端时间，行活动，缓存命中，CPU消耗，时间消耗细分。</p>
   </td>
   </tr>
   <tr id="row205775151415"><td class="cellrowborder" valign="top" width="27.27%" headers="mcps1.2.3.1.1 "><p id="p15283141442"><a name="p15283141442"></a><a name="p15283141442"></a>SQL Detail（集群/节点范围）</p>
   </td>
   <td class="cellrowborder" valign="top" width="72.72999999999999%" headers="mcps1.2.3.1.2 "><p id="p55772158111"><a name="p55772158111"></a><a name="p55772158111"></a>SQL语句文本详情。</p>
   </td>
   </tr>
   </tbody>
   </table>



## 数据安全维护建议

为保证openGauss数据库中的数据安全，避免丢失数据、非法访问数据等事故发生，请仔细阅读以下内容。

### 避免数据被丢失<a name="zh-cn_topic_0237088812_zh-cn_topic_0085413817_zh-cn_topic_0059781987_s838b550f384b449bb87e13a200bf04cd"></a>

建议用户规划周期性的物理备份，且对备份文件进行可靠的保存。在系统发生严重错误的情况下，可以利用备份文件，将系统恢复到备份前的状态。

### 避免数据被非法访问<a name="zh-cn_topic_0237088812_zh-cn_topic_0085413817_zh-cn_topic_0059781987_s654ff86682394156a57cf0860791b723"></a>

-   建议对数据库用户进行权限分级管理。数据库管理员根据业务需要，建立用户并赋予权限，保证各用户对数据库的合理访问。
-   对于openGauss的服务端和客户端（或基于客户端库开发的应用程序），最好也部署在可信任的内网中。如果服务端和客户端一定要部署在非信任的网络中，需要在服务启动前，打开SSL加密，保证数据在非信任网络上的传输安全。需要注意的是，打开SSL加密会降低数据库的性能。

### 避免系统日志泄露个人数据<a name="zh-cn_topic_0237088812_zh-cn_topic_0085413817_zh-cn_topic_0059781987_s2ff16280ae30412c9f531f105fd2d6c6"></a>

-   将调试日志发给他人进行分析前，请删除个人数据。

    >![](public_sys-resources/icon-note.gif) **说明：** 
    >因为日志级别（log\_min\_messages）设置为DEBUGx（x为DEBUG级别，取值范围为1\~5）时，调试日志中记录的信息可能包含用户的个人数据。

- 将系统日志发给其他人进行分析前，请删除个人数据。因为在默认配置下，当SQL语句执行错误时，日志中会记录出错的SQL语句，而这些SQL语句中可能包含用户个人数据。

-   将log_min_error_statement参数的值设置为PANIC，可以避免将出错的SQL语句记录在系统日志中。若禁用该功能，当出现故障时，很难定位故障原因。

## 慢sql诊断

### 背景信息<a name="section11436171655914"></a>

在SQL语句执行性能不符合预期时，可以查看SQL语句执行信息，便于事后分析SQL语句执行时的行为，从而诊断SQL语句执行出现的相关问题。

### 前提条件<a name="section18794625615"></a>

-   数据库实例运行正常。
-   查询SQL语句信息，需要合理设置GUC参数track\_stmt\_stat\_level。track_stmt_stat_level参数控制语句执行跟踪的级别，第一部分控制全量SQL，第二部分控制慢SQL。对于慢SQL，当track_stmt_stat_level的值为非OFF时，且SQL执行时间超过log_min_duration_statement，会记录为慢SQL。默认值为"OFF,L0"，建议设置为"L0,L0"。
-   只能用系统管理员和监控管理员权限进行操作。

```
执行命令查看数据库实例中SQL语句执行信息
select * from dbe_perf.get_global_full_sql_by_timestamp(start_timestamp, end_timestamp); 
例如：
select * from DBE_PERF.get_global_full_sql_by_timestamp('2020-12-01 09:25:22', '2020-12-31 23:54:41');
-[ RECORD 1 ]--------+---------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------
node_name            | dn_6001_6002_6003
db_name              | postgres
schema_name          | "$user",public
origin_node          | 1938253334
user_name            | user_dj
application_name     | gsql
client_addr          |
client_port          | -1
unique_query_id      | 3671179229
debug_query_id       | 72339069014839210
query                | select name, setting from pg_settings where name in (?)
start_time           | 2020-12-19 16:19:51.216818+08
finish_time          | 2020-12-19 16:19:51.224513+08
slow_sql_threshold   | 1800000000
transaction_id       | 0
thread_id            | 139884662093568
session_id           | 139884662093568
n_soft_parse         | 0
n_hard_parse         | 1
query_plan           | Datanode Name: dn_6001_6002_6003
                     | Function Scan on pg_show_all_settings a  (cost=0.00..12.50 rows=5 width=64)
                     |   Filter: (name = '***'::text)
...

执行命令查看数据库实例中慢SQL语句执行信息
select * from dbe_perf.get_global_slow_sql_by_timestamp(start_timestamp, end_timestamp);
例如：
select * from DBE_PERF.get_global_slow_sql_by_timestamp('2020-12-01 09:25:22', '2020-12-31 23:54:41');
-[ RECORD 1 ]--------+---------------------------------------------------------------------------------------------------
node_name            | dn_6001_6002_6003
db_name              | postgres
schema_name          | "$user",public
origin_node          | 1938253334
user_name            | user_dj
application_name     | gsql
client_addr          |
client_port          | -1
unique_query_id      | 2165004317
debug_query_id       | 72339069014839319
query                | select * from DBE_PERF.get_global_slow_sql_by_timestamp(?, ?);
start_time           | 2020-12-19 16:23:20.738491+08
finish_time          | 2020-12-19 16:23:20.773714+08
slow_sql_threshold   | 10000
transaction_id       | 0
thread_id            | 139884662093568
session_id           | 139884662093568
n_soft_parse         | 10
n_hard_parse         | 8
query_plan           | Datanode Name: dn_6001_6002_6003
                     | Result  (cost=1.01..1.02 rows=1 width=0)
                     |   InitPlan 1 (returns $0)
                     |     ->  Seq Scan on pgxc_node  (cost=0.00..1.01 rows=1 width=64)
                     |           Filter: (nodeis_active AND ((node_type = '***'::"char") OR (node_type = '***'::"char")))
...

查看当前主节点SQL语句执行信息
select * from statement_history;
例如：
select * from statement_history;
-[ RECORD 1 ]--------+---------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------
db_name              | postgres
schema_name          | "$user",public
origin_node          | 1938253334
user_name            | user_dj
application_name     | gsql
client_addr          |
client_port          | -1
unique_query_id      | 3671179229
debug_query_id       | 72339069014839210
query                | select name, setting from pg_settings where name in (?)
start_time           | 2020-12-19 16:19:51.216818+08
finish_time          | 2020-12-19 16:19:51.224513+08
slow_sql_threshold   | 1800000000
transaction_id       | 0
thread_id            | 139884662093568
session_id           | 139884662093568
n_soft_parse         | 0
n_hard_parse         | 1
query_plan           | Datanode Name: dn_6001_6002_6003
                     | Function Scan on pg_show_all_settings a  (cost=0.00..12.50 rows=5 width=64)
                     |   Filter: (name = '***'::text)
...

查看当前备节点SQL语句执行信息
select * from dbe_perf.standby_statement_history(is_only_slow, start_timestamp, end_timestamp);
例如：
select * from dbe_perf.standby_statement_history(true, '2022-08-01 09:25:22', '2022-08-31 23:54:41');
db_name              | postgres
schema_name          | "$user",public
origin_node          | 0
user_name            | user_dj
application_name     | gsql
client_addr          |
client_port          | -1
unique_query_id      | 1660376009
debug_query_id       | 281474976710740
query                | select name, setting from pg_settings where name in (?)
start_time           | 2022-08-19 16:19:51.216818+08
finish_time          | 2022-08-19 16:19:51.224513+08
slow_sql_threshold   | 1800000000
transaction_id       | 0
thread_id            | 140058747205376
session_id           | 140058747205376
n_soft_parse         | 0
n_hard_parse         | 1
query_plan           | Datanode Name: sgnode
                     | Function Scan on pg_show_all_settings a  (cost=0.00..12.50 rows=5 width=64)
                     |   Filter: (name = '***'::text)
...
```

