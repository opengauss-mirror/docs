# 告警监控插件用户手册

## 功能介绍
告警监控插件主要目的是为 openGauss 用户提供告警和通知能力。它作为一体化平台的可插拔插件开发，本特性依赖于openGauss一体化平台的插件特性。

告警监控分告警记录、告警配置、告警模板、告警规则、通知模板和通知方式，而通知方式又分为通知方式和通知渠道。

告警监控插件提供的功能如下：

<a name="table1652718018281"></a>
<table><tbody>
<tr id="row14118151122812"><td class="cellrowborder" valign="top" width="20%"><p id="p10118181152814"><a name="p10118181152814"></a><a name="p10118181152814"></a><strong id="b1711814115287"><a name="b1711814115287"></a><a name="b1711814115287"></a><span>功能模块</span></strong></p>
</td>
<td class="cellrowborder" valign="top" width="40%"><p id="p1311815110284"><a name="p1311815110284"></a><a name="p1311815110284"></a><strong id="b511810110288"><a name="b511810110288"></a><a name="b511810110288"></a><span>功能说明</span></strong></p>
</td>
</tr>
<tr> 
<td>告警记录</td>
<td>展示告警信息。<br />统计告警信息。 <br />显示关联视图或日志：根据告警规则获取指标或者日志的告警数据，通过图表展示。</td>
</tr>
<tr> 
<td>告警配置</td>
<td>展示告警配置列表。<br />支持为单个或者批量实例配置模板，也可以直接为实例配置规则。</td>
</tr>
<tr> 
<td>告警模板</td>
<td>展示告警模板列表。 <br />支持增删改查。 <br />支持对告警模板中的规则进行修改。</td>
</tr>
<tr> 
<td>告警规则</td>
<td>展示告警规则列表，支持增删改查。 <br />已内置规则：CPU使用率、内存使用率、磁盘使用率、IO、网络、数据库状态、数据库连接数、数据库阻塞会话数、慢SQL、表空间容量、数据库LOCK个数和锁时间的告警。</td>
</tr>
<tr> 
<td>通知模板</td>
<td>展示通知模板列表，支持增删改查。</td>
</tr>
<tr> 
<td>通知方式</td>
<td>展示通知方式列表，支持增删改查。<br />支持邮箱、企业微信、钉钉、Webhook、SNMP等通知方式。</td>
</tr>
<tr> 
<td>通知渠道</td>
<td>展示发送人的邮箱、企业微信和钉钉相关信息，支持修改。 <br />提供通知渠道是否有效的测试功能。</td>
</tr>
</tbody>
</table>

### 约束和限制

**安装插件前提**

安装该插件之前，必须先安装实例监控插件，并在插件中安装prometheus。

**第一次使用**

第一次安装该插件时，需要设置告警接口的IP地址（默认是DataKit一体化平台IP地址）和端口号（默认值：9494）。

![32](./figures/32.png)

**项目运行**

本项目依赖一体化主平台，若需要使用本项目所有功能，只能通过编译成 jar 包的形式作为插件运行在主平台上。

### 系统要求

本节介绍使用告警监控插件的最低系统要求。

**浏览器兼容性**

| 内置对象 \ 浏览器及版本                                      | Chrome | Edge | Firefox | Opera | Safari |
| :----------------------------------------------------------- | :----: | :--: | :-----: | :---: | :----: |
| `Proxy`                                                      |   49   |  12  |   18    |  36   |   10   |
| [`Proxy()` constructor](https://developer.mozilla.org/en-US/./figures/figuress/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy) |   49   |  12  |   18    |  36   |   10   |
| [`revocable`](https://developer.mozilla.org/en-US/./figures/figuress/Web/JavaScript/Reference/Global_Objects/Proxy/revocable) |   63   |  12  |   34    |  50   |   10   |

**系统要求**

| 操作系统 | 版本            |
| -------- | --------------- |
| Windows  | Windows 7及以上 |

**软件要求**

| 软件 | 规格        |
| ---- | ----------- |
| Java | jdk 8及以上 |

**数据库版本要求**

| 数据库    | 版本 |
| --------- | ---- |
| openGauss | 所有 |


## 使用指导

### 告警记录

​		当触发告警后，Prometheus将告警信息推送到平台，平台将告警信息记录下来，并在告警记录页面展示出来。同时，告警记录支持查看告警详细以及告警的相关指标的关联视图。

####  告警记录列表

点击DataKit菜单【告警监控】-【告警记录】，进入告警记录列表，显示告警统计信息、饼图和列表，支持【集群/实例】、【告警时间范围】查询，同时支持将数据标记为“未读”和“已读”，支持告警导出。

![11](./figures/11.png)

#### 告警详情

点击上面的告警记录列表数据中的【查看】按钮，进入告警详情。

![12](./figures/12.png)

#### 告警导出

在告警记录主页面中，点击【导出】按钮，弹出弹框，选择【导出清单】或者【导出报告】，点击【确定】，即可导出对应的数据。如果是导出清单，则Excel文件，文件内容为告警列表；如果是导出报告，则导出html文件，文件包括告警记录信息和告警列表

![33](./figures/33.png)

![34](./figures/34.png)

![35](./figures/35.png)

### 告警配置

​		为实例配置告警模板（包含多个告警规则），并展示在告警配置页面中。同时将实例的告警规则配置到prometheus配置文件中，prometheus将根据配置的规则对实例进行监控。

#### 告警配置列表显示

点击DataKit菜单【告警监控】-【告警配置】，进入告警配置列表，显示告警配置列表，支持根据实例名称进行查询。

![13](./figures/13.png)

#### 告警配置

在上面的告警配置列表中，选择数据，点击列表上方的【配置】按钮，或者直接列表点击【配置】按钮，进入告警配置页面。

![14](./figures/14.png)

2、告警配置可根据告警模板进行配置，也可以直接选择告警规则进行配置。

告警模板配置：在【选择告警模板】tab中，选择告警模板，点击【确定】，即可为实例配置告警模板。

![14-1](./figures/14-1.png)

告警规则配置：点击【选择告警规则】tab,选择规则，点击【确定】，提示生成告警模板，再点击【确定】，即可为实例配置新生成的告警模板。

![15](./figures/15.png)

![15](./figures/15-1.png)

若选择规则的过程中需要对规则进行编辑，点击【选择告警规则】tab中，列表的【操作】列中【编辑】按钮，对规则进行编辑。

| 配置项       | 必填 | **组件形式**   | 配置说明                                                     |
| ------------ | ---- | -------------- | ------------------------------------------------------------ |
| 规则名称     | 是   | 输入框         | 禁止输入，置灰状态                                           |
| 规则类型     | 是   | 单选框         | 禁止选择，置灰状态，分指标和日志两种类型，目前只支持指标类型 |
| 告警级别     | 是   | 单选框         | 分严重、警告、提示三个等级                                   |
| 告警规则     | 是   | 输入框和下拉框 | 禁止输入，置灰状态                                           |
| 告警规则组合 | 是   | 输入框和下拉框 | 禁止输入，置灰状态                                           |
| 告警内容     | 是   | 输入框         | 根据【告警内容说明】对告警内容进行设置，告警触发时，发送给用户 |
| 统计周期     | 是   | 输入框和下拉框 | 告警统计时长，即告警超过该统计周期后，将通知用户。禁止输入，置灰状态 |
| 告警描述     | 否   | 输入框         | 对该告警规则进行描述或者备注                                 |
| 告警通知     | 是   | 多选框         | 分告警时和告警恢复时。告警时：指发生告警向用户发通知；告警恢复时：指告警恢复时，向用户发通知 |
| 是否重复告警 | 是   | 单选框         | 已经进行告警通知后，再次触发告警，是否需要继续发送通知       |
| 是否静默     | 是   | 单选框         | 是否设置静默时间，选择【是】之后，需要选择对应的静默时间段，即在该时间段内发生了告警，也不会进行通知 |
| 通知方式     | 是   | 下拉框         | 可选择多个通知方式                                           |

![16](./figures/16.png)

### 告警模板

告警模板统一组合多个告警规则，为实例提供统一配置告警规则的模板。同时支持对告警规则的再次编辑（比如对告警规则的阈值更改）。告警模板展示模板列表，支持对模板进行增删改查，支持对模板中的规则进行启动或者停止。

#### 告警模板列表

点击DataKit菜单【告警监控】-【告警模板】，进入告警模板列表，显示告警模板列表。告警模板列表支持【模板名称】模糊搜索；告警规则列表支持【规则名称】模糊搜索，并支持规则启动/停止。

![17](./figures/17.png)

#### 新增或者修改模板

1. 在上面的告警模板页面左侧的告警模板列表中，点击【新增】或者直接点击列表中的【编辑】按钮，进入编辑页面。

2. 输入【模板名称】，选择【告警规则】，点击【确定】，即可新增或者修改告警模板。

    **说明：** 

    - 所有必选参数均需要填写。必填参数用星号（*）标识。
    
    - 点击【确定】按钮后，保存告警模板信息。
    
    - 点击【取消】按钮后，取消本次新增或者编辑告警信息。
    
    | 配置项   | 必填 | **组件形式** | 配置说明                                           |
    | -------- | ---- | ------------ | -------------------------------------------------- |
    | 模板名称 | 是   | 输入框       | 输入模板名称，不能为空                             |
    | 选择规则 | 是   | 可选列表     | 规则列表，支持对规则进行编辑，点击【编辑】按钮即可 |

    ![18](./figures/18.png)

3. 对告警规则再次编辑，可修改告警级别、告警内容、告警规则阈值、告警描述、告警通知、是否重复通知、是否静默、通知方式等等。

    **说明：**  

    - 点击【确定】按钮后，保存告警规则信息。
    
    - 点击【取消】按钮后，取消本次告警规则的修改。
    
    | 配置项       | 必填 | **组件形式**   | 配置说明                                                     |
    | ------------ | ---- | -------------- | ------------------------------------------------------------ |
    | 规则名称     | 是   | 输入框         | 禁止输入，置灰状态                                           |
    | 规则类型     | 是   | 单选框         | 禁止选择，置灰状态，分指标和日志两种类型，目前只支持指标类型 |
    | 告警级别     | 是   | 单选框         | 分严重、警告、提示三个等级                                   |
    | 告警规则     | 是   | 输入框和下拉框 | 禁止输入，置灰状态                                           |
    | 告警规则组合 | 是   | 输入框和下拉框 | 禁止输入，置灰状态                                           |
    | 告警内容     | 是   | 输入框         | 根据【告警内容说明】对告警内容进行设置，告警触发时，发送给用户 |
    | 统计周期     | 是   | 输入框和下拉框 | 告警统计时长，即告警超过该统计周期后，将通知用户。禁止输入，置灰状态 |
    | 告警描述     | 否   | 输入框         | 对该告警规则进行描述或者备注                                 |
    | 告警通知     | 是   | 多选框         | 分告警时和告警恢复时。告警时：指发生告警向用户发通知；告警恢复时：指告警恢复时，向用户发通知 |
    | 是否重复告警 | 是   | 单选框         | 已经进行告警通知后，再次触发告警，是否需要继续发送通知       |
    | 是否静默     | 是   | 单选框         | 是否设置静默时间，选择【是】之后，需要选择对应的静默时间段，即在该时间段内发生了告警，也不会进行通知 |
    | 通知方式     | 是   | 下拉框         | 可选择多个通知方式                                           |

    ![18](./figures/19.png)

#### 删除告警模板

在告警模板页面左侧的告警模板列表中，点击列表中的【删除】按钮，弹出删除提示，点击【确定】按钮，即可删除告警模板。

**说明：** 

- 【删除】操作不可逆。

- 当实例已配置告警模板时，无法删除已配置的告警模板。

    ![18](./figures/20.png)

### 告警规则

告警规则主要内置多种规则，提供给告警模板进行配置。告警规则页面展示告警规则列表，并能支持增删改查。

#### 告警规则列表

点击DataKit菜单【告警监控】-【告警规则】，进入告警规则页面，显示告警规则列表。支持【规则名称】、【规则类型】、【告警级别】查询。

![21](./figures/21.png)

#### 告警规则详细

点击告警规则列表中的某个数据的【查看】按钮，进入规则详细页面。

![22](./figures/22.png)


#### 保存告警规则

点击告警规则列表上方的【新增】或者列表中的某个数据的【修改】按钮，进入规则编辑页面，填写完表单，提交数据。

![36](./figures/36.png)

#### 删除告警规则

点击告警规则列表中的某个数据的【删除】按钮，弹出删除提示弹框，点击【确定】，即可删除数据。

![37](./figures/37.png)

### 通知模板

对告警通知的内容进行个性化包装，当出现告警时，将包装后的内容发给用户。支持增删改查，用于通知方式设置。

####  通知模板列表

点击DataKit菜单【告警监控】-【通知模板】，进入通知模板页面，显示通知模板列表。支持【模板名称】、【模板类型】查询。

![23](./figures/23.png)

#### 新增/修改通知模板

1. 点击通知模板页面中的【新增】按钮或者点击通知模板列表中的【修改】按钮，进入模板修改页面。

2.  输入表单，点击【确定】，即可新增或者修改通知模板。

    **说明：** 

     - 所有必选参数均需要填写。必填参数用星号（*）标识。

     - 点击【确定】按钮后，保存通知模板信息。

     - 点击【取消】按钮后，取消本次新增或者编辑通知模板信息。
    
    | 配置项   | 必填 | **组件形式** | 配置说明                                                     |
    | -------- | ---- | ------------ | ------------------------------------------------------------ |
    | 模板名称 | 是   | 输入框       | 通知模板名称，必填                                           |
    | 模板类型 | 是   | 下拉框       | 分邮箱、企业微信、钉钉，必选                                 |
    | 模板描述 | 否   | 输入框       | 对模板进行描述或者备注                                       |
    | 通知主题 | 是   | 输入框       | 必填                                                         |
    | 通知内容 | 是   | 文本框       | 发送给用户的内容，主要对告警内容进行包装，支持参数配置，具体参考【消息内容说明】，必填 |
    | 消息预览 | 否   | 文本框       | 主要是对通知内容的预览，禁止输入                             |

    ![24](./figures/24.png)

    ![24](./figures/24-1.png)

#### 删除通知模板

点击通知模板列表中的【删除】按钮，弹出删除提示，点击【确定】按钮，即可对通知模板进行删除。

**说明：** 
- 【删除】操作不可逆。

- 当通知方式已配置通知模板时，无法删除已配置的通知模板。

![25](./figures/25.png)

### 通知方式

配置通知人的相关信息（邮件、钉钉、企业微信）和通知模板，为告警规则提供通知方式，支持增删改查。

#### 通知方式列表

点击DataKit菜单【告警监控】-【通知方式】，默认选择【通知方式】tab，进入通知方式页面，显示通知方式列表,支持【通知方式名称】、【发送方式】查询。

![26](./figures/26.png)

#### 新增/修改通知方式

1. 点击通知方式页面中的【新增】按钮或者点击列表中的【修改】按钮，进入通知方式修改页面。

2. 输入表单，点击【确定】，即可新增或者修改通知方式。

    **说明：** 

    - 所有必选参数均需要填写。必填参数用星号（*）标识。

    - 点击【确定】按钮后，保存通知方式信息。

    - 点击【取消】按钮后，取消本次新增或者编辑通知方式信息。
    
    | 配置项       | 必填 | **组件形式** | 配置说明                                                     |
    | ------------ | ---- | ------------ | ------------------------------------------------------------ |
    | 通知方式名称 | 是   | 输入框       | 通知模板名称，必填                                           |
    | 发送方式     | 是   | 下拉框       | 分邮箱、企业微信、钉钉、webhook、SNMP，必选                  |
    | 邮箱         | 否   | 输入框       | 当发送方式为邮箱时显示，必填                                 |
    | 用户ID       | 否   | 输入框       | 当发送方式为企业微信或者钉钉时显示，且用户ID和部门ID其中有一个必填 |
    | 部门ID       | 否   | 输入框       | 当发送方式为企业微信或者钉钉时显示，且用户ID和部门ID其中有一个必填 |
    | 通知模板     | 是   | 下拉框       | 分邮箱模板、企业微信模板、钉钉模板，必填                     |
    | 发送类型     | 否   | 单选框       | 发送方式为企业微信或者钉钉时,必填                            |
    | webhook      | 否   | 输入框       | 发送类型为机器人推送或者发送方式为webhook时，必填            |
    | 加签         | 否   | 输入框       | 发送方式为钉钉，发送类型为机器人推送时有效                   |
    | header       | 否   | 输入框       | 发送方式为webhook有效                                        |
    | 参数         | 否   | 输入框       | 发送方式为webhook有效                                        |
    | body         | 否   | 输入框       | 发送方式为webhook有效                                        |
    | 返回成功码   | 否   | 输入框       | 发送方式为webhook有效                                        |
    | IP           | 否   | 输入框       | 发送方式为SNMP有效，必填                                     |
    | 端口         | 否   | 输入框       | 发送方式为SNMP有效，必填                                     |
    | Community    | 否   | 输入框       | 发送方式为SNMP有效，必填                                     |
    | Oid          | 否   | 输入框       | 发送方式为SNMP有效，必填                                     |
    | Version      | 否   | 输入框       | 发送方式为SNMP有效，必填                                     |
    | 用户名       | 否   | 输入框       | 发送方式为SNMP，并且Version为v3时有效，必填                  |
    | 鉴权密码     | 否   | 输入框       | 发送方式为SNMP，并且Version为v3时有效，必填                  |
    | 加密密码     | 否   | 输入框       | 发送方式为SNMP，并且Version为v3时有效，必填                  |

    ![27](./figures/27.png)
    
    ![27](./figures/27-1.png)
    
    ![27](./figures/27-3.png)
    
    ![27](./figures/27-2.png)
    
    ![27](./figures/27-4.png)
    
    ![27](./figures/27-5.png)
    
    ![27](./figures/27-6.png)

####  删除通知方式

点击通知方式列表中的【**删除**】按钮，弹出删除提示，点击【确定】按钮，即可对通知方式进行删除。

**说明：** 
- 【删除】操作不可逆。

- 当告警规则已配置通知方式时，无法删除已配置的通知方式。

    ![28](./figures/28.png)

###  通知渠道

配置发送人的邮箱、企业微信、钉钉等等。

#### 通知渠道页面

1. 点击DataKit菜单【告警监控】-【通知方式】，选择【通知渠道】Tab，进入通知渠道页面。

2. 修改相关配置，点击【**确定**】按钮，可修改通知渠道。

    ![29](./figures/29.png)

3. 点击右边的【**测试**】按钮，弹出弹框，选择【通知方式】，点击【确定】按钮，对通知渠道进行测试。

    ![30](./figures/30.png)

    ![30](./figures/30-2.png)
