# 行列融合

openGauss HTAP 行列融合特性在单机、主备场景下，通过高效行列转换技术方案，在备节点额外维护一份列缓存数据。备节点同步主节点在OLTP场景下大量的行数据变更至列缓存，以保证列缓存数据的新鲜度。openGauss支持备节点通过列缓存查询，从而提升大型复杂OLAP场景下的数据分析，使数据库同时具备较强的TP和AP能力。


## 使用指导
HTAP 行列融合特性支持用户针对全表、表指定列、指定分区进行行列转换及清除已有列缓存操作。

-   **对指定行表进行行列转换**
    -   **转换方式1：全表转换**
        ```
        ALTER TABLE table_name IMCSTORED;
        ```
    -   **转换方式2：表部分列转换**
        ```
        ALTER TABLE table_name IMCSTORED(column_name_list);
        ```
    -   **转换方式3：对分区表的指定分区转换**
        ```
        ALTER TABLE table_name MODIFY PARTITION partition_name IMCSTORED;
        ```

    -   **转换方式4：对分区表的指定分区的部分列转换，支持不同分区转换不同列**
        ```
        ALTER TABLE table_name MODIFY PARTITION partition_name IMCSTORED(column_name_list);
        ```
        
-   **清除已转换的列缓存**
    -   **清除方式1：对指定行表做全量列缓存清除**
        ```
        ALTER TABLE table_name UNIMCSTORED;
        ```
    -   **清除方式2：对分区表的指定分区做列缓存清除**
        ```
        ALTER TABLE table_name MODIFY PARTITION partition_name UNIMCSTORED;
        ```
## 参数说明<a name="section415419560710"></a>

-   **table\_name**

    要转换的表名。
-   **column\_name\_list**

    指定表中要行转列的字段名列表，如 （name, age）。

-   **partition\_name**

    要转换的分区名。

## 示例<a name="zh-cn_topic_0283136734_zh-cn_topic_0237120296_zh-cn_topic_0066331191_zh-cn_topic_0059778293_s05b88010070445598ab2a86454e5d88b"></a>

对已创建的行存表进行行列转换。例如：

```
--创建普通表
openGauss=# CREATE TABLE test
(
  id   INT,
  name VARCHAR2(40),
  dept_id    INT
);

CREATE TABLE

--对该表进行行列转换
openGauss=# ALTER TABLE test IMCSTORED;
ALTER TABLE

--查询该表，执行行存计划
openGauss=# EXPLAIN SELECT * FROM test;
                       QUERY PLAN                        
---------------------------------------------------------
 Seq Scan on test  (cost=0.00..16.01 rows=601 width=106)
(1 row)
--开启列存扫描计划
openGauss=# SET enable_imcsscan=on;
SET

--查询该表，执行列存计划
openGauss=# EXPLAIN SELECT * FROM test;
                             QUERY PLAN                             
--------------------------------------------------------------------
 Row Adapter  (cost=10.60..10.60 rows=601 width=106)
   ->  IMCStore Scan on test  (cost=0.00..10.60 rows=601 width=106)
(2 rows)

--对该表清除列缓存
openGauss=# ALTER TABLE test UNIMCSTORED;
ALTER TABLE

--对该表部分列进行行列转换
openGauss=# ALTER TABLE test IMCSTORED(id);
ALTER TABLE
```

```
--创建分区表
openGauss=# CREATE TABLE test_partition
(
  id   INT,
  name VARCHAR2(40),
  dept_id    INT,
  age  INT
) PARTITION BY RANGE(dept_id) SUBPARTITION BY RANGE (age) 
(
    PARTITION dept_id_p1 VALUES LESS THAN (5) (
        SUBPARTITION age_sub_p1 VALUES LESS THAN (25),
        SUBPARTITION age_sub_p2 VALUES LESS THAN (35),
        SUBPARTITION age_sub_p3 VALUES LESS THAN (maxvalue)
    ),
    PARTITION dept_id_p2 VALUES LESS THAN (maxvalue) (
        SUBPARTITION age_sub_p4 VALUES LESS THAN (25),
        SUBPARTITION age_sub_p5 VALUES LESS THAN (35),
        SUBPARTITION age_sub_p6 VALUES LESS THAN (maxvalue)
    )
);

CREATE TABLE

--对该表进行全量行列转换，即所有分区、所有列
openGauss=# ALTER TABLE test_partition IMCSTORED;
ALTER TABLE

--对该表清除列缓存
openGauss=# ALTER TABLE test_partition UNIMCSTORED;
ALTER TABLE

--对该表 dept_id_p1 分区的所有列进行行列转换
openGauss=# ALTER TABLE test_partition MODIFY PARTITION dept_id_p1 IMCSTORED;
ALTER TABLE

--对该表 dept_id_p1 分区清除列缓存
openGauss=# ALTER TABLE test_partition MODIFY PARTITION dept_id_p1 UNIMCSTORED;
ALTER TABLE

--对该表 dept_id_p1 分区的 id, name 列进行行列转换
openGauss=# ALTER TABLE test_partition MODIFY PARTITION dept_id_p1 IMCSTORED(id, name);
ALTER TABLE

--对该表 dept_id_p2 分区的 name, age 列进行行列转换
openGauss=# ALTER TABLE test_partition MODIFY PARTITION dept_id_p2 IMCSTORED(name, age);
ALTER TABLE

--开启列存扫描计划
openGauss=# SET enable_imcsscan=on;
SET

--查询该表 dept_id_p1 分区的 id, name 列, 执行列存计划
openGauss=# EXPLAIN SELECT id, name FROM test_partition PARTITION(dept_id_p1);
                                          QUERY PLAN                                           
-----------------------------------------------------------------------------------------------
 Row Adapter  (cost=5.58..5.58 rows=583 width=102)
   ->  Vector Partition Iterator  (cost=0.00..5.58 rows=583 width=102)
         Iterations: 1, Sub Iterations: 3
         ->  Partitioned IMCStore Scan on test_partition  (cost=0.00..5.58 rows=583 width=102)
               Selected Partitions:  1
               Selected Subpartitions:  ALL
(6 rows)

--查询该表 dept_id_p2 分区的 name, age 列, 执行列存计划
openGauss=# EXPLAIN SELECT name, age FROM test_partition PARTITION(dept_id_p2);
                                          QUERY PLAN                                           
-----------------------------------------------------------------------------------------------
 Row Adapter  (cost=5.58..5.58 rows=583 width=102)
   ->  Vector Partition Iterator  (cost=0.00..5.58 rows=583 width=102)
         Iterations: 1, Sub Iterations: 3
         ->  Partitioned IMCStore Scan on test_partition  (cost=0.00..5.58 rows=583 width=102)
               Selected Partitions:  2
               Selected Subpartitions:  ALL
(6 rows)

--查询整张表 id, name 列, dept_id_p2 未转换 id 列, 执行行存计划
openGauss=# EXPLAIN SELECT name, age FROM test_partition;
                                     QUERY PLAN                                      
-------------------------------------------------------------------------------------
 Partition Iterator  (cost=0.00..15.83 rows=583 width=102)
   Iterations: 2, Sub Iterations: 6
   ->  Partitioned Seq Scan on test_partition  (cost=0.00..15.83 rows=583 width=102)
         Selected Partitions:  1..2
         Selected Subpartitions:  ALL
(5 rows)

--查询整张表 name 列, dept_id_p1、dept_id_p2 均转换 name 列, 因此执行列存计划
openGauss=# EXPLAIN SELECT name FROM test_partition;
                                          QUERY PLAN                                           
-----------------------------------------------------------------------------------------------
 Row Adapter  (cost=10.58..10.58 rows=583 width=98)
   ->  Vector Partition Iterator  (cost=0.00..10.58 rows=583 width=98)
         Iterations: 2, Sub Iterations: 6
         ->  Partitioned IMCStore Scan on test_partition  (cost=0.00..10.58 rows=583 width=98)
               Selected Partitions:  1..2
               Selected Subpartitions:  ALL
(6 rows)
```

