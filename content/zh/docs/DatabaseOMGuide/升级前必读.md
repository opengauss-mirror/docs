# 升级前必读<a name="ZH-CN_TOPIC_0305491437"></a>

-   **[升级方案](#升级方案)**  

-   **[升级前的版本要求（升级路径）](#升级前的版本要求)**  

-   **[升级影响和升级约束](#升级影响和升级约束)**  

## 升级方案

本节为指导用户选择升级方式。

用户根据openGauss提供的新特性和数据库现状，确定是否对现有系统进行升级。

当前支持的升级模式为就地升级、灰度升级和指定节点升级。升级方式的策略又分为大版本升级和小版本升级。版本号不变的升级方式为小版本升级，否则就是大版本升级。升级软件包的版本号在升级文件压缩包中的version.cfg的第2行查看。当前版本的版本号在$GAUSSHOME/bin下面upgrade_version文件的第2行查看。

用户挑选升级方式后，系统会自动判断并选择合适的升级策略。

就地升级：升级期间需停止业务进行，一次性升级所有节点。

灰度升级：灰度升级支持全业务操作，也是一次性升级所有节点。\(openGauss1.1.0版本之后的版本支持该功能\)

指定节点升级：基于灰度升级，支持升级指定节点，支持部分节点升级。\(openGauss3.1.0版本之后的版本支持该功能\)

## 升级前的版本要求

openGauss升级版本要求如[表1](#table7961729)所示。

**表 1**  升级前的版本要求（升级路径）

<a name="table7961729"></a>

<table><tbody><tr id="row48398424"><td class="cellrowborder" valign="top" width="41.410000000000004%"><p id="p27958252"><a name="p27958252"></a><a name="p27958252"></a>版本</p>
</td>
<td class="cellrowborder" valign="top" width="58.589999999999996%"><p id="p50025933"><a name="p50025933"></a><a name="p50025933"></a>升级说明</p>
</td>
</tr>
<tr id="row5917164"><td class="cellrowborder" valign="top" width="41.410000000000004%"><p id="p138378421424"><a name="p138378421424"></a><a name="p138378421424"></a>openGauss1.0.1版本之前的版本</p>
</td>
<td class="cellrowborder" valign="top" width="58.589999999999996%"><p id="p33594135"><a name="p33594135"></a><a name="p33594135"></a>可以升级到openGauss1.0.1之前的任意版本。</p>
</td>
</tr>
<tr id="row1699043202811"><td class="cellrowborder" valign="top" width="41.410000000000004%"><p id="p16990230282"><a name="p16990230282"></a><a name="p16990230282"></a>openGauss1.0.1版本</p>
</td>
<td class="cellrowborder" valign="top" width="58.589999999999996%"><p id="p89903322814"><a name="p89903322814"></a><a name="p89903322814"></a>可以升级到openGauss1.1.0版本</p>
</td>
</tr>
<tr id="row10729745336"><td class="cellrowborder" valign="top" width="41.410000000000004%"><p id="p473019455316"><a name="p473019455316"></a><a name="p473019455316"></a>openGauss1.1.0版本之后的版本</p>
</td>
<td class="cellrowborder" valign="top" width="58.589999999999996%"><p id="p207301045037"><a name="p207301045037"></a><a name="p207301045037"></a>可以升级到openGauss1.1.0<span id="ph148981056131915"><a name="ph148981056131915"></a><a name="ph148981056131915"></a>-</span><span id="ph1016120202013"><a name="ph1016120202013"></a><a name="ph1016120202013"></a>openGauss3.1.0</span>之<span id="ph1423101082010"><a name="ph1423101082010"></a><a name="ph1423101082010"></a>间</span>的任意版本<span id="ph131021321192010"><a name="ph131021321192010"></a><a name="ph131021321192010"></a>，不包含</span><span id="ph4749182672019"><a name="ph4749182672019"></a><a name="ph4749182672019"></a>openGauss3.1.0</span><span id="ph4332122812016"><a name="ph4332122812016"></a><a name="ph4332122812016"></a>版本。</span></p>
</td>
</tr>
</tbody>
</table>

**重点说明：** 升级只保证LTS版本升级成功，创新版本不保证升级成功，优先推荐安装LTS版本，不推荐使用创新版上生产环境。

>![](public_sys-resources/icon-note.gif) **说明：** 
>升级前版本，可以通过执行如下工具查看。
>
>```
>gsql -V | --version
>```



## 升级影响和升级约束

升级过程需要注意以下事项。

- 升级操作不能和扩容、缩容同时执行。

- 不支持虚拟IP。

- 升级过程中，不允许对wal\_level，max\_connections，max\_prepared\_transactions，max\_locks\_per\_transaction这四个GUC参数的值进行修改。如果修改，会导致回滚后实例启动异常。

- 建议在数据库系统空闲情况下进行升级，尽量避开业务繁忙的时间段（可按照经验判断，如节假日等）。

- 升级前尽可能保证数据库正常。可以通过gs\_om -t status查询，查询结果的cluster\_state为Normal代表数据库正常。

- 升级前保证数据库互信正常，可以在任意节点上，通过ssh hostname命令，连接另外一个节点进行验证。如果各机器间互连不用输入密码，说明互信正常（通常数据库状态正常时，互信一般都是正常的）。

- 升级前后，数据库的部署方式（配置文件）不能发生变化。升级前会对部署方式进行校验，如果改变，会报错。

- 升级前要保证操作系统处于健康状态，通过gs\_checkos工具可以完成操作系统状态检查。

- 就地升级需要停止业务，灰度升级支持全业务操作。

- 数据库运行正常且主DN的数据完全同步到备DN。

- 升级过程中不允许打开kerberos开关。

- 请不要修改安装包中解压出来的version.cfg文件。

- 如果升级过程中出现异常导致升级失败，需用户手动回滚，并且必须回滚成功后才能进行下一次升级。

- 如果升级回滚成功后，再次升级成功，未提交阶段设置的GUC参数将失效。

- 执行升级的过程中请不要手动设置GUC参数。

- 灰度升级中，升级的时候都会产生不超过10s的业务中断。

- 升级过程中，必须保持内核版本与om版本一致才可执行om操作。这里的一致是指，内核代码和om代码都来自同一个软件包。如果执行了升级包的前置脚本却没有升级，或者升级回滚后没有执行基线包的前置脚本，就会造成内核代码和om代码的不一致。

- 升级过程中如果系统表新增了字段，升级后通过`\d`命令将查看不到这些新增的字段。此时通过`select`命令可以查到这些新增的字段。

- 升级需要guc参数enable\_stream\_replication=on，该参数为off时不允许升级。

- 灰度升级中， 业务并发要小于200并发读加200并发写的情况。

- 若在openGauss2.0.0之前的版本中使用了MOT表，则不支持升级到openGauss2.0.0版本。

- 升级过程中，请勿在当前机器上安装其他opengGauss数据库集群。

- 升级中会连接template0库，期间执行create database会报错。

- openGauss资源池化模式集群仅支持从基线版本大于等于5.0.0的版本升级到之后的版本。

- openGauss资源池化模式集群不支非资源池化集群升级到资源池化集群以及资源池化集群升级到非资源池化集群，不支持RDMA模式下的升级。

- openGauss资源池化模式集群升级不再备份catalog物理文件，请在升级前使用gs_probackup备份数据，防止故障后数据丢失。

- PL/Java升级约束

  从3.0.0及其之前版本升级到3.1.0及其后续版本时，如果业务使用PL/Java功能且数据库实例所在机器上不存在java环境时，升级前check检查将失败。因此需提前确认是否使用到PL/Java功能和当前的JAVA版本。检查方法为：

  1. 在数据库中使用初始化用户执行“select count\(1\) from pg\_proc where prolang = 15;”命令。

     -   如果结果\> 0，说明数据库使用了PL/Java，参考[2](#li1343863405415)进一步检查是否有Java环境。
     -   如果结果= 0，说明数据库没有使用PL/Java。则结束本校验，执行其他校验流程。

  2. <a name="li1343863405415"></a>在操作系统中使用root用户执行“java -version”命令。

     ```
     java -version
     ```

     -   如果Java存在，且版本等于或高于JDK1.8，则结束本校验，执行其他校验流程。
     -   如果Java不存在或版本低于JDK1.8，则需要参考[3](#li243351914413)进行JDK的下载及Java环境变量的配置。

  3. <a name="li243351914413"></a>JDK的下载及Java环境变量的配置。

     可从官网下载或者使用此链接下载：https://www.hikunpeng.com/zh/developer/devkit/compiler/jdk，并通过以下方式配置环境变量：

     ```
     export JAVA_HOME=/xxx/jdk1.xxx
     export PATH=$JAVA_HOME/bin:$PATH 
     export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar 
     ```



>![](public_sys-resources/icon-note.gif) **说明：** 
>
>+ JDK目录及版本需根据实际路径及版本号进行替换。
>
>+ 升级检查仅校验执行升级命令的节点的Java环境变量，若其他节点也需要使用PL/Java，请同步进行JDK的下载及Java环境变量的配置，否则PL/Java将无法使用。



