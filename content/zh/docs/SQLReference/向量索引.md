# 向量索引

DataVec向量引擎目前支持了[IVFFLAT](#IVFFlat)、[HNSW](#HNSW)及HNSWPQ等算法，基于openGauss中的ASTORE和USTORE存储实现，通过索引结构能够高效地检索出查询结果。

## HNSW
```
CREATE INDEX [INDEX_NAME] 
ON [TABLE_NAME] 
USING hnsw (COLUMN_NAME [TYPE]_[DISTANCE_FUN]_ops) 
with (m=<M>, ef_construction=<EF_CONSTRUCTION>);
```

- `INDEX_NAME` - 索引名
- `TABLE_NAME` - 表名
- `COLUMN_NAME` - 向量数据列名

### HNSW索引操作符

HNSW索引操作符`[TYPE]_[DISTANCE_FUN]_ops` 格式：

- `TYPE` - 向量类型
    - vector
    - bit
    - sparsevec

HNSW索引支持向量数据维度：
名称 | 维度限制 
--- | --- 
vector | 2,000 
bit | 64,000 
sparsevec | 1,000,000,000<br>1,000 非零元素数 

- `DISTANCE_FUN` - 距离函数
    - l2
    - ip
    - cosine
    - l1
    - hamming
    - jaccard

#### vector 索引操作符
索引操作符 | 描述 
--- | --- 
vector_l2_ops | L2距离
vector_ip_ops | 内积
vector_cosine_ops | 余弦距离
vector_l1_ops | L1距离

#### bit 索引操作符
索引操作符 | 描述 
--- | --- 
bit_hamming_ops | 汉明距离
bit_jaccard_ops | 杰卡德距离

#### sparsevec 索引操作符
索引操作符 | 描述 
--- | --- 
sparsevec_l2_ops | L2距离
sparsevec_ip_ops | 内积
sparsevec_cosine_ops | 余弦距离
sparsevec_l1_ops | L1距离

### 索引选项
-   `m` - 每个图层最大连接数（默认为16）
-   `ef_construction` - 用于图形构造的动态候选集大小（默认为64）
-   `storage` - 索引存储类型：astore/ustore
-   `parallel_workers` - 构建索引并行度
-   `append` - 是否开启append页面，只能在`storage=astore`下使用

**示例3：** 使用L2距离计算创建HNSW索引并设置`m = 16, ef_construction = 64`。
```
openGauss=# CREATE INDEX ON items USING hnsw (embedding vector_l2_ops) WITH (m = 16, ef_construction = 64);
```
提高 `ef_construction` 可以提供更好的召回率，但会增加索引构建和插入速度。

### 查询选项
-   `ef_search` - 查询时的动态候选集大小（默认为40），详情请参考[DataVec向量引擎参数](../DatabaseReference/DataVec向量引擎参数.md)。

**示例4：** 设置当前回话中`ef_search=100`。
```
openGauss=# SET hnsw_ef_search = 100;
```

## IVFFlat
```
CREATE INDEX [INDEX_NAME] 
ON [TABLE_NAME] 
USING ivfflat (COLUMN_NAME [TYPE]_[DISTANCE_FUN]_ops) 
WITH (lists = <LISTS>);
```

- `INDEX_NAME` - 索引名
- `TABLE_NAME` - 表名
- `COLUMN_NAME` - 向量数据列名

### IVFFlat索引操作符

IVFFlat索引操作符`[TYPE]_[DISTANCE_FUN]_ops` 格式：

- `TYPE` - 向量类型
    - vector
    - bit

IVFFlat索引支持向量数据维度：
名称 | 维度限制
--- | --- 
vector | 2,000 
bit | 64,000 

- `DISTANCE_FUN` - 距离函数
    - l2
    - ip
    - cosine
    - hamming

#### vector 索引操作符
索引操作符 | 描述 
--- | --- 
vector_l2_ops | L2距离
vector_ip_ops | 内积
vector_cosine_ops | 余弦距离

#### bit 索引操作符
索引操作符 | 描述 
--- | --- 
bit_hamming_ops | 汉明距离

sparsevec不支持IVFFLAT索引

### 索引选项
-   `lists` - 倒排表（单元格）聚类聚类中心数量（默认为100）
-   `parallel_workers` - 构建索引并行度

**示例5：** 使用L2距离计算创建IVFFlat索引并设置lists = 200。
```
openGauss=# CREATE INDEX ON items USING ivfflat (embedding vector_l2_ops) WITH (lists = 200);
```
>![](public_sys-resources/icon-note.png) **说明：**
>
>优化召回率：
> - 在表中有数据后创建索引。
> - 选取适当的`lists`， 建议当数据集在100万行及以内：`rows / 1000`；超过100万行的数据：`sqrt(rows)`。
> - 查询时指定适当数量的probe，建议`sqrt(lists)`。

### 查询选项
-   `probe` - 查询时候选集的大小（默认为1），详情请参考[DataVec向量引擎参数](../DatabaseReference/DataVec向量引擎参数.md)。
```
openGauss=# SET ivfflat_probes = 10;
```

## 非向量化索引：Btree/Ubtree
向量数据类型同时也支持btree和ubtree索引构建，会跟随数据表存储类型自动选择。

```
CREATE INDEX [INDEX_NAME] 
ON [TABLE_NAME] 
(COLUMN_NAME [TYPE]_ops) ;
```

#### btree/ubtree 索引操作符
- vector_ops
- bit_ops
- sparsevec_ops

**示例6：** 构建btree索引。
```
openGauss=# CREATE INDEX ON t (val vector_ops);
```

>![](public_sys-resources/icon-note.png) **说明：**
> Btree以及Ubtree索引不包含向量距离计算，只基于[向量函数和操作符](向量函数和操作符.md)中的向量比较。

## 并行构建向量索引
通过开启并行构建功能来加速向量索引的创建：
```
ALTER TABLE [TABLE_NAME] 
SET (parallel_workers = <CONCURRENCY_NUM>);
```

**示例7：** 构建索引并行数设置为8。
```
openGauss=# ALTER TABLE items SET (parallel_workers = 8);
```

## 修改向量索引

仅支持修改向量索引选项
```
ALTER INDEX [INDEX_NAME]
SET (parameter=<OPTIONS>);
```

**示例7：** 修改向量索引选项
```
openGauss=# ALTER INDEX t_val_idx SET (m=24, ef_construction=200);
openGauss=# REINDEX INDEX t_val_idx;
```
>![](public_sys-resources/icon-note.png) **说明：**
>修改向量索引参数后需使用`REINDEX`更新索引，并且REINDEX支持并行，并行度仍根据数据表中`parallel_workers`决定。
>不支持修改索引操作符，如vector_l2_ops到vector_cosine_ops。

## 约束
- 向量索引仅支持普通行存表，临时表，Toast表，Unlogged表，段页式表等，其他表仅支持对向量数据创建btree和ubtree索引。
- 若ALTER INDEX后不执行REINDEX，后插入的数据会根据新的索引选项构建索引，而索引中已存在的数据不会因此改变。
- IVFFLAT索引不支持ustore存储。
- 构建带有向量表时可以使用INDEX子句构建默认btree、ubtree索引，无法指定向量索引。